<!DOCTYPE html>

<html lang="en" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>geniza.corpus.views &#8212; Princeton Geniza Project 4.21.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css?v=12dfc556" />
    <script src="../../../_static/documentation_options.js?v=d460739f"></script>
    <script src="../../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for geniza.corpus.views</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ast</span><span class="w"> </span><span class="kn">import</span> <span class="n">literal_eval</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">copy</span><span class="w"> </span><span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">random</span><span class="w"> </span><span class="kn">import</span> <span class="n">randint</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">dal</span><span class="w"> </span><span class="kn">import</span> <span class="n">autocomplete</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.conf</span><span class="w"> </span><span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib</span><span class="w"> </span><span class="kn">import</span> <span class="n">messages</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.admin.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">CHANGE</span><span class="p">,</span> <span class="n">LogEntry</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.auth.mixins</span><span class="w"> </span><span class="kn">import</span> <span class="n">PermissionRequiredMixin</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.contenttypes.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">ContentType</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.postgres.aggregates</span><span class="w"> </span><span class="kn">import</span> <span class="n">ArrayAgg</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.postgres.search</span><span class="w"> </span><span class="kn">import</span> <span class="n">SearchVector</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.core.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">ValidationError</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Q</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models.query</span><span class="w"> </span><span class="kn">import</span> <span class="n">Prefetch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.http</span><span class="w"> </span><span class="kn">import</span> <span class="n">Http404</span><span class="p">,</span> <span class="n">HttpResponse</span><span class="p">,</span> <span class="n">JsonResponse</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.http.response</span><span class="w"> </span><span class="kn">import</span> <span class="n">HttpResponsePermanentRedirect</span><span class="p">,</span> <span class="n">HttpResponseRedirect</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.middleware.csrf</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_token</span> <span class="k">as</span> <span class="n">csrf_token</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.shortcuts</span><span class="w"> </span><span class="kn">import</span> <span class="n">redirect</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.urls</span><span class="w"> </span><span class="kn">import</span> <span class="n">reverse</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.utils.html</span><span class="w"> </span><span class="kn">import</span> <span class="n">strip_tags</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.utils.safestring</span><span class="w"> </span><span class="kn">import</span> <span class="n">mark_safe</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.utils.text</span><span class="w"> </span><span class="kn">import</span> <span class="n">Truncator</span><span class="p">,</span> <span class="n">slugify</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.utils.translation</span><span class="w"> </span><span class="kn">import</span> <span class="n">gettext</span> <span class="k">as</span> <span class="n">_</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.utils.translation</span><span class="w"> </span><span class="kn">import</span> <span class="n">ngettext</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.views.generic</span><span class="w"> </span><span class="kn">import</span> <span class="n">DetailView</span><span class="p">,</span> <span class="n">FormView</span><span class="p">,</span> <span class="n">ListView</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.views.generic.edit</span><span class="w"> </span><span class="kn">import</span> <span class="n">FormMixin</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">parasolr.django.views</span><span class="w"> </span><span class="kn">import</span> <span class="n">SolrLastModifiedMixin</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">piffle.presentation</span><span class="w"> </span><span class="kn">import</span> <span class="n">IIIFPresentation</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tabular_export.admin</span><span class="w"> </span><span class="kn">import</span> <span class="n">export_to_csv_response</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">taggit.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Tag</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">geniza.common.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">absolutize_url</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">geniza.corpus</span><span class="w"> </span><span class="kn">import</span> <span class="n">iiif_utils</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">geniza.corpus.forms</span><span class="w"> </span><span class="kn">import</span> <span class="n">DocumentMergeForm</span><span class="p">,</span> <span class="n">DocumentSearchForm</span><span class="p">,</span> <span class="n">TagMergeForm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">geniza.corpus.ja</span><span class="w"> </span><span class="kn">import</span> <span class="n">contains_arabic</span><span class="p">,</span> <span class="n">contains_hebrew</span><span class="p">,</span> <span class="n">ja_arabic_chars</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">geniza.corpus.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Document</span><span class="p">,</span> <span class="n">TextBlock</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">geniza.corpus.solr_queryset</span><span class="w"> </span><span class="kn">import</span> <span class="n">DocumentSolrQuerySet</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">geniza.corpus.templatetags</span><span class="w"> </span><span class="kn">import</span> <span class="n">corpus_extras</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">geniza.footnotes.forms</span><span class="w"> </span><span class="kn">import</span> <span class="n">SourceChoiceForm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">geniza.footnotes.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Footnote</span><span class="p">,</span> <span class="n">Source</span>


<div class="viewcode-block" id="SolrDateRangeMixin">
<a class="viewcode-back" href="../../../codedocs/corpus.html#geniza.corpus.views.SolrDateRangeMixin">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">SolrDateRangeMixin</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Mixin for solr-based views with start and end date fields to get</span>
<span class="sd">    the full range of dates across the solr queryset.&quot;&quot;&quot;</span>

    <span class="c1"># NOTE: should cache this, shouldn&#39;t really change that frequently</span>
<div class="viewcode-block" id="SolrDateRangeMixin.get_range_stats">
<a class="viewcode-back" href="../../../codedocs/corpus.html#geniza.corpus.views.SolrDateRangeMixin.get_range_stats">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_range_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queryset_cls</span><span class="p">,</span> <span class="n">field_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the min and max for range fields based on Solr stats.</span>

<span class="sd">        :returns: Dictionary keyed on form field name with a tuple of</span>
<span class="sd">            (min, max) as integers. If stats are not returned from the field,</span>
<span class="sd">            the key is not added to a dictionary.</span>
<span class="sd">        :rtype: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="n">queryset_cls</span><span class="p">()</span><span class="o">.</span><span class="n">stats</span><span class="p">(</span><span class="s2">&quot;start_dating_i&quot;</span><span class="p">,</span> <span class="s2">&quot;end_dating_i&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get_stats</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;stats_fields&quot;</span><span class="p">):</span>
            <span class="c1"># use minimum from start date and max from end date</span>
            <span class="c1"># - we&#39;re storing YYYYMMDD as 8-digit number for this we only want year</span>
            <span class="c1"># convert to str, take first 4 digits, then convert back to int</span>
            <span class="n">min_val</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;stats_fields&quot;</span><span class="p">][</span><span class="s2">&quot;start_dating_i&quot;</span><span class="p">][</span><span class="s2">&quot;min&quot;</span><span class="p">]</span>
            <span class="n">max_val</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;stats_fields&quot;</span><span class="p">][</span><span class="s2">&quot;end_dating_i&quot;</span><span class="p">][</span><span class="s2">&quot;max&quot;</span><span class="p">]</span>

            <span class="c1"># trim from the end to handle 3-digit years; includes .0 at end</span>
            <span class="n">min_year</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">min_val</span><span class="p">)[:</span><span class="o">-</span><span class="mi">6</span><span class="p">])</span> <span class="k">if</span> <span class="n">min_val</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">max_year</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">max_val</span><span class="p">)[:</span><span class="o">-</span><span class="mi">6</span><span class="p">])</span> <span class="k">if</span> <span class="n">max_val</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="p">{</span><span class="n">field_name</span><span class="p">:</span> <span class="p">(</span><span class="n">min_year</span><span class="p">,</span> <span class="n">max_year</span><span class="p">)}</span>

        <span class="k">return</span> <span class="p">{}</span></div>
</div>



<div class="viewcode-block" id="DocumentSearchView">
<a class="viewcode-back" href="../../../codedocs/corpus.html#geniza.corpus.views.DocumentSearchView">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DocumentSearchView</span><span class="p">(</span>
    <span class="n">ListView</span><span class="p">,</span> <span class="n">FormMixin</span><span class="p">,</span> <span class="n">SolrLastModifiedMixin</span><span class="p">,</span> <span class="n">SolrDateRangeMixin</span>
<span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Document</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">DocumentSearchForm</span>
    <span class="n">context_object_name</span> <span class="o">=</span> <span class="s2">&quot;documents&quot;</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s2">&quot;corpus/document_list.html&quot;</span>
    <span class="c1"># Translators: title of document search page</span>
    <span class="n">page_title</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Documents&quot;</span><span class="p">)</span>
    <span class="c1"># Translators: description of document search page, for search engines</span>
    <span class="n">page_description</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Search and browse Geniza documents.&quot;</span><span class="p">)</span>
    <span class="n">paginate_by</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="n">initial</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;sort&quot;</span><span class="p">:</span> <span class="s2">&quot;random&quot;</span><span class="p">,</span> <span class="s2">&quot;mode&quot;</span><span class="p">:</span> <span class="s2">&quot;general&quot;</span><span class="p">,</span> <span class="s2">&quot;regex_field&quot;</span><span class="p">:</span> <span class="s2">&quot;transcription&quot;</span><span class="p">}</span>
    <span class="c1"># NOTE: does not filter on status, since changing status could modify the page</span>
    <span class="n">solr_lastmodified_filters</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;item_type_s&quot;</span><span class="p">:</span> <span class="s2">&quot;document&quot;</span><span class="p">}</span>
    <span class="n">applied_filter_labels</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># map form sort to solr sort field</span>
    <span class="n">solr_sort</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;relevance&quot;</span><span class="p">:</span> <span class="s2">&quot;-score&quot;</span><span class="p">,</span>
        <span class="s2">&quot;scholarship_desc&quot;</span><span class="p">:</span> <span class="s2">&quot;-scholarship_count_i&quot;</span><span class="p">,</span>
        <span class="s2">&quot;scholarship_asc&quot;</span><span class="p">:</span> <span class="s2">&quot;scholarship_count_i&quot;</span><span class="p">,</span>
        <span class="s2">&quot;input_date_desc&quot;</span><span class="p">:</span> <span class="s2">&quot;-input_date_dt&quot;</span><span class="p">,</span>
        <span class="s2">&quot;input_date_asc&quot;</span><span class="p">:</span> <span class="s2">&quot;input_date_dt&quot;</span><span class="p">,</span>
        <span class="s2">&quot;shelfmark&quot;</span><span class="p">:</span> <span class="s2">&quot;shelfmark_natsort&quot;</span><span class="p">,</span>
        <span class="s2">&quot;docdate_asc&quot;</span><span class="p">:</span> <span class="s2">&quot;start_date_i&quot;</span><span class="p">,</span>
        <span class="s2">&quot;docdate_desc&quot;</span><span class="p">:</span> <span class="s2">&quot;-end_date_i&quot;</span><span class="p">,</span>
        <span class="s2">&quot;docdating_asc&quot;</span><span class="p">:</span> <span class="s2">&quot;start_dating_i&quot;</span><span class="p">,</span>
        <span class="s2">&quot;docdating_desc&quot;</span><span class="p">:</span> <span class="s2">&quot;-end_dating_i&quot;</span><span class="p">,</span>
    <span class="p">}</span>

<div class="viewcode-block" id="DocumentSearchView.dispatch">
<a class="viewcode-back" href="../../../codedocs/corpus.html#geniza.corpus.views.DocumentSearchView.dispatch">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># special case: for random sort we only show the first page of results</span>
        <span class="c1"># if any other page is requested, redirect to first page</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sort&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;random&quot;</span> <span class="ow">and</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;page&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="s2">&quot;1&quot;</span><span class="p">:</span>
            <span class="n">queryargs</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">del</span> <span class="n">queryargs</span><span class="p">[</span><span class="s2">&quot;page&quot;</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span>
                <span class="s2">&quot;?&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;corpus:document-search&quot;</span><span class="p">),</span> <span class="n">queryargs</span><span class="o">.</span><span class="n">urlencode</span><span class="p">()])</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="DocumentSearchView.last_modified">
<a class="viewcode-back" href="../../../codedocs/corpus.html#geniza.corpus.views.DocumentSearchView.last_modified">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">last_modified</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;override last modified from solr mixin to not return a value when</span>
<span class="sd">        sorting by random&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sort&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;random&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">last_modified</span><span class="p">()</span></div>


<div class="viewcode-block" id="DocumentSearchView.get_solr_sort">
<a class="viewcode-back" href="../../../codedocs/corpus.html#geniza.corpus.views.DocumentSearchView.get_solr_sort">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_solr_sort</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sort_option</span><span class="p">,</span> <span class="n">exclude_inferred</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return solr sort field for user-seleted sort option;</span>
<span class="sd">        generates random sort field using solr random dynamic field;</span>
<span class="sd">        otherwise uses solr sort field from :attr:`solr_sort`&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">sort_option</span> <span class="o">==</span> <span class="s2">&quot;random&quot;</span><span class="p">:</span>
            <span class="c1"># use solr&#39;s random dynamic field to sort randomly</span>
            <span class="k">return</span> <span class="s2">&quot;random_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">randint</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">9999</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s2">&quot;docdate&quot;</span> <span class="ow">in</span> <span class="n">sort_option</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">exclude_inferred</span><span class="p">:</span>
            <span class="c1"># use inferred datings if exclude_inferred is not true</span>
            <span class="n">sort_option</span> <span class="o">=</span> <span class="n">sort_option</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="s2">&quot;dating&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">solr_sort</span><span class="p">[</span><span class="n">sort_option</span><span class="p">]</span></div>


<div class="viewcode-block" id="DocumentSearchView.get_form_kwargs">
<a class="viewcode-back" href="../../../codedocs/corpus.html#geniza.corpus.views.DocumentSearchView.get_form_kwargs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_form_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;get form arguments from request and configured defaults&quot;&quot;&quot;</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_form_kwargs</span><span class="p">()</span>
        <span class="c1"># use GET instead of default POST/PUT for form data</span>
        <span class="n">form_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># sort by chosen sort</span>
        <span class="k">if</span> <span class="s2">&quot;sort&quot;</span> <span class="ow">in</span> <span class="n">form_data</span> <span class="ow">and</span> <span class="nb">bool</span><span class="p">(</span><span class="n">form_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sort&quot;</span><span class="p">)):</span>
            <span class="n">form_data</span><span class="p">[</span><span class="s2">&quot;sort&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">form_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sort&quot;</span><span class="p">)</span>
        <span class="c1"># sort by relevance if query text exists and no sort chosen</span>
        <span class="k">elif</span> <span class="n">form_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">form_data</span><span class="p">[</span><span class="s2">&quot;sort&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;relevance&quot;</span>

        <span class="c1"># Otherwise set all form values to default</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">form_data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

        <span class="c1"># Handle empty string for sort</span>
        <span class="k">if</span> <span class="s2">&quot;sort&quot;</span> <span class="ow">in</span> <span class="n">form_data</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">(</span><span class="n">form_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sort&quot;</span><span class="p">)):</span>
            <span class="n">form_data</span><span class="p">[</span><span class="s2">&quot;sort&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial</span><span class="p">[</span><span class="s2">&quot;sort&quot;</span><span class="p">]</span>

        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">form_data</span>
        <span class="c1"># get min/max configuration for document date range field</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;range_minmax&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_range_stats</span><span class="p">(</span>
            <span class="n">queryset_cls</span><span class="o">=</span><span class="n">DocumentSolrQuerySet</span><span class="p">,</span> <span class="n">field_name</span><span class="o">=</span><span class="s2">&quot;docdate&quot;</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">kwargs</span></div>


<div class="viewcode-block" id="DocumentSearchView.get_applied_filter_labels">
<a class="viewcode-back" href="../../../codedocs/corpus.html#geniza.corpus.views.DocumentSearchView.get_applied_filter_labels">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_applied_filter_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">filters</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;return a list of objects with field/value pairs, and translated labels,</span>
<span class="sd">        one for each applied filter&quot;&quot;&quot;</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">:</span>
            <span class="c1"># remove escape characters</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="c1"># get translated label using form helper method</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">get_translated_label</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="c1"># return object with original field and value, so we can unapply programmatically</span>
            <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="n">field</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">label</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">labels</span></div>


<div class="viewcode-block" id="DocumentSearchView.get_boolfield_label">
<a class="viewcode-back" href="../../../codedocs/corpus.html#geniza.corpus.views.DocumentSearchView.get_boolfield_label">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_boolfield_label</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">,</span> <span class="n">fieldname</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a label dict for a boolean field (works differently than other fields)&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="n">fieldname</span><span class="p">,</span>
            <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;on&quot;</span><span class="p">,</span>
            <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">fieldname</span><span class="p">]</span><span class="o">.</span><span class="n">label</span><span class="p">,</span>
        <span class="p">}</span></div>


<div class="viewcode-block" id="DocumentSearchView.get_queryset">
<a class="viewcode-back" href="../../../codedocs/corpus.html#geniza.corpus.views.DocumentSearchView.get_queryset">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform requested search and return solr queryset&quot;&quot;&quot;</span>
        <span class="c1"># limit to documents with published status (i.e., no suppressed documents);</span>
        <span class="c1"># get counts of facets, excluding type filter</span>
        <span class="n">documents</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">DocumentSolrQuerySet</span><span class="p">()</span>
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">Document</span><span class="o">.</span><span class="n">PUBLIC_LABEL</span><span class="p">)</span>
            <span class="o">.</span><span class="n">facet</span><span class="p">(</span>
                <span class="s2">&quot;has_image&quot;</span><span class="p">,</span>
                <span class="s2">&quot;has_digital_edition&quot;</span><span class="p">,</span>
                <span class="s2">&quot;has_digital_translation&quot;</span><span class="p">,</span>
                <span class="s2">&quot;has_discussion&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">facet_field</span><span class="p">(</span>
                <span class="s2">&quot;translation_language&quot;</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="s2">&quot;translation_language&quot;</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="s2">&quot;value&quot;</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">facet_field</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="s2">&quot;value&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">applied_filter_labels</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">form</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_form</span><span class="p">()</span>
        <span class="c1"># return empty queryset if not valid</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">documents</span> <span class="o">=</span> <span class="n">documents</span><span class="o">.</span><span class="n">none</span><span class="p">()</span>

        <span class="c1"># when form is valid, check for search term and filter queryset</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">search_opts</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span>

            <span class="k">if</span> <span class="n">search_opts</span><span class="p">[</span><span class="s2">&quot;q&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">search_opts</span><span class="p">[</span><span class="s2">&quot;mode&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;regex&quot;</span><span class="p">:</span>
                <span class="n">regex_field</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">search_opts</span><span class="p">[</span><span class="s1">&#39;regex_field&#39;</span><span class="p">]</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;transcription&#39;</span><span class="si">}</span><span class="s2">_regex&quot;</span>
                <span class="c1"># use regex search if &quot;mode&quot; is &quot;regex&quot;</span>
                <span class="n">documents</span> <span class="o">=</span> <span class="n">documents</span><span class="o">.</span><span class="n">regex_search</span><span class="p">(</span><span class="n">regex_field</span><span class="p">,</span> <span class="n">search_opts</span><span class="p">[</span><span class="s2">&quot;q&quot;</span><span class="p">])</span>

            <span class="k">elif</span> <span class="n">search_opts</span><span class="p">[</span><span class="s2">&quot;q&quot;</span><span class="p">]:</span>
                <span class="c1"># NOTE: using requireFieldMatch so that field-specific search</span>
                <span class="c1"># terms will NOT be used for highlighting text matches</span>
                <span class="c1"># (unless they are in the appropriate field)</span>
                <span class="n">documents</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">documents</span><span class="o">.</span><span class="n">keyword_search</span><span class="p">(</span><span class="n">search_opts</span><span class="p">[</span><span class="s2">&quot;q&quot;</span><span class="p">])</span>
                    <span class="o">.</span><span class="n">highlight</span><span class="p">(</span>
                        <span class="s2">&quot;description&quot;</span><span class="p">,</span>
                        <span class="n">snippets</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                        <span class="n">method</span><span class="o">=</span><span class="s2">&quot;unified&quot;</span><span class="p">,</span>
                        <span class="n">requireFieldMatch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="o">.</span><span class="n">highlight</span><span class="p">(</span>
                        <span class="s2">&quot;description_nostem&quot;</span><span class="p">,</span>
                        <span class="n">snippets</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                        <span class="n">method</span><span class="o">=</span><span class="s2">&quot;unified&quot;</span><span class="p">,</span>
                        <span class="n">requireFieldMatch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="c1"># return smaller chunk of highlighted text for transcriptions/translations</span>
                    <span class="c1"># since the lines are often shorter, resulting in longer text</span>
                    <span class="o">.</span><span class="n">highlight</span><span class="p">(</span>
                        <span class="s2">&quot;transcription&quot;</span><span class="p">,</span>
                        <span class="n">method</span><span class="o">=</span><span class="s2">&quot;unified&quot;</span><span class="p">,</span>
                        <span class="n">fragsize</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span>  <span class="c1"># try including more context</span>
                        <span class="n">requireFieldMatch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="c1"># use newline as passage boundary</span>
                        <span class="o">**</span><span class="p">{</span><span class="s2">&quot;bs.type&quot;</span><span class="p">:</span> <span class="s2">&quot;SEPARATOR&quot;</span><span class="p">,</span> <span class="s2">&quot;bs.separator&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">},</span>
                    <span class="p">)</span>
                    <span class="o">.</span><span class="n">highlight</span><span class="p">(</span>
                        <span class="s2">&quot;translation&quot;</span><span class="p">,</span>
                        <span class="n">method</span><span class="o">=</span><span class="s2">&quot;unified&quot;</span><span class="p">,</span>
                        <span class="n">fragsize</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span>
                        <span class="n">requireFieldMatch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="o">.</span><span class="n">highlight</span><span class="p">(</span>
                        <span class="s2">&quot;transcription_nostem&quot;</span><span class="p">,</span>
                        <span class="n">method</span><span class="o">=</span><span class="s2">&quot;unified&quot;</span><span class="p">,</span>
                        <span class="n">fragsize</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span>
                        <span class="n">requireFieldMatch</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="o">**</span><span class="p">{</span><span class="s2">&quot;bs.type&quot;</span><span class="p">:</span> <span class="s2">&quot;SEPARATOR&quot;</span><span class="p">,</span> <span class="s2">&quot;bs.separator&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">},</span>
                    <span class="p">)</span>
                    <span class="c1"># highlight old shelfmark so we can show match in results</span>
                    <span class="o">.</span><span class="n">highlight</span><span class="p">(</span><span class="s2">&quot;old_shelfmark&quot;</span><span class="p">,</span> <span class="n">requireFieldMatch</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">highlight</span><span class="p">(</span><span class="s2">&quot;old_shelfmark_t&quot;</span><span class="p">,</span> <span class="n">requireFieldMatch</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">also</span><span class="p">(</span><span class="s2">&quot;score&quot;</span><span class="p">)</span>
                <span class="p">)</span>  <span class="c1"># include relevance score in results</span>

            <span class="c1"># order by sort option</span>
            <span class="n">order_by</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_solr_sort</span><span class="p">(</span>
                    <span class="n">search_opts</span><span class="p">[</span><span class="s2">&quot;sort&quot;</span><span class="p">],</span> <span class="n">search_opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;exclude_inferred&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="c1"># in all sorts except random and shelfmark, order</span>
            <span class="c1"># secondarily by shelfmark, in order to break ties</span>
            <span class="k">if</span> <span class="s2">&quot;random&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">order_by</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="s2">&quot;shelfmark&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">order_by</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">order_by</span> <span class="o">+=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solr_sort</span><span class="p">[</span><span class="s2">&quot;shelfmark&quot;</span><span class="p">],)</span>
            <span class="n">documents</span> <span class="o">=</span> <span class="n">documents</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="o">*</span><span class="n">order_by</span><span class="p">)</span>

            <span class="c1"># filter by type if specified</span>
            <span class="k">if</span> <span class="n">search_opts</span><span class="p">[</span><span class="s2">&quot;doctype&quot;</span><span class="p">]:</span>
                <span class="n">typelist</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">search_opts</span><span class="p">[</span><span class="s2">&quot;doctype&quot;</span><span class="p">])</span>
                <span class="n">quoted_typelist</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">doctype</span> <span class="k">for</span> <span class="n">doctype</span> <span class="ow">in</span> <span class="n">typelist</span><span class="p">]</span>
                <span class="n">documents</span> <span class="o">=</span> <span class="n">documents</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">type__in</span><span class="o">=</span><span class="n">quoted_typelist</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">applied_filter_labels</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_applied_filter_labels</span><span class="p">(</span>
                    <span class="n">form</span><span class="p">,</span> <span class="s2">&quot;doctype&quot;</span><span class="p">,</span> <span class="n">typelist</span>
                <span class="p">)</span>

            <span class="c1"># filter by translation language if specified</span>
            <span class="k">if</span> <span class="n">search_opts</span><span class="p">[</span><span class="s2">&quot;translation_language&quot;</span><span class="p">]:</span>
                <span class="n">lang</span> <span class="o">=</span> <span class="n">search_opts</span><span class="p">[</span><span class="s2">&quot;translation_language&quot;</span><span class="p">]</span>
                <span class="n">documents</span> <span class="o">=</span> <span class="n">documents</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                    <span class="n">translation_language</span><span class="o">=</span><span class="n">lang</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s2">&quot;translation_language&quot;</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">applied_filter_labels</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_applied_filter_labels</span><span class="p">(</span>
                    <span class="n">form</span><span class="p">,</span> <span class="s2">&quot;translation_language&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">lang</span><span class="p">]</span>
                <span class="p">)</span>

            <span class="c1"># image filter</span>
            <span class="k">if</span> <span class="n">search_opts</span><span class="p">[</span><span class="s2">&quot;has_image&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">documents</span> <span class="o">=</span> <span class="n">documents</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">has_image</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">applied_filter_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">get_boolfield_label</span><span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="s2">&quot;has_image&quot;</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="c1"># scholarship filters</span>
            <span class="k">if</span> <span class="n">search_opts</span><span class="p">[</span><span class="s2">&quot;has_transcription&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">documents</span> <span class="o">=</span> <span class="n">documents</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">has_digital_edition</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">applied_filter_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">get_boolfield_label</span><span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="s2">&quot;has_transcription&quot;</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">search_opts</span><span class="p">[</span><span class="s2">&quot;has_discussion&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">documents</span> <span class="o">=</span> <span class="n">documents</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">has_discussion</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">applied_filter_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">get_boolfield_label</span><span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="s2">&quot;has_discussion&quot;</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">search_opts</span><span class="p">[</span><span class="s2">&quot;has_translation&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">documents</span> <span class="o">=</span> <span class="n">documents</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">has_digital_translation</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">applied_filter_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">get_boolfield_label</span><span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="s2">&quot;has_translation&quot;</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">search_opts</span><span class="p">[</span><span class="s2">&quot;docdate&quot;</span><span class="p">]:</span>
                <span class="c1"># date range filter; returns tuple of value or None for open-ended range</span>
                <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">search_opts</span><span class="p">[</span><span class="s2">&quot;docdate&quot;</span><span class="p">]</span>
                <span class="n">date_filter</span> <span class="o">=</span> <span class="s2">&quot;[</span><span class="si">%s</span><span class="s2"> TO </span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">start</span> <span class="ow">or</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">end</span> <span class="ow">or</span> <span class="s2">&quot;*&quot;</span><span class="p">)</span>
                <span class="n">date_field</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;document_date_dr&quot;</span>
                    <span class="k">if</span> <span class="n">search_opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;exclude_inferred&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                    <span class="k">else</span> <span class="s2">&quot;document_dating_dr&quot;</span>
                <span class="p">)</span>
                <span class="n">documents</span> <span class="o">=</span> <span class="n">documents</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">date_field</span><span class="p">:</span> <span class="n">date_filter</span><span class="p">})</span>
                <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">–</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">start</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">end</span><span class="p">:</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;After </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">start</span>
                <span class="k">elif</span> <span class="n">end</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">start</span><span class="p">:</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Before </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">end</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">applied_filter_labels</span> <span class="o">+=</span> <span class="p">[</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="s2">&quot;docdate&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">search_opts</span><span class="p">[</span><span class="s2">&quot;docdate&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">label</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">queryset</span> <span class="o">=</span> <span class="n">documents</span>

        <span class="k">return</span> <span class="n">documents</span></div>


<div class="viewcode-block" id="DocumentSearchView.get_paginate_by">
<a class="viewcode-back" href="../../../codedocs/corpus.html#geniza.corpus.views.DocumentSearchView.get_paginate_by">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_paginate_by</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queryset</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Try to get pagination from GET request query,</span>
<span class="sd">        if there is none fallback to the original.&quot;&quot;&quot;</span>
        <span class="n">paginate_by</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_paginate_by</span><span class="p">(</span><span class="n">queryset</span><span class="p">)</span>

        <span class="c1"># NOTE: This may be reimplemented as a part of the form later</span>
        <span class="n">req_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="s2">&quot;per_page&quot;</span> <span class="ow">in</span> <span class="n">req_params</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">per_page</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">req_params</span><span class="p">[</span><span class="s2">&quot;per_page&quot;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">per_page</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">paginate_by</span><span class="p">:</span>
                    <span class="n">paginate_by</span> <span class="o">=</span> <span class="n">per_page</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="n">paginate_by</span></div>


    <span class="c1"># base url for APD searches</span>
    <span class="n">apd_base_url</span> <span class="o">=</span> <span class="s2">&quot;https://www.apd.gwi.uni-muenchen.de/apd/asearch.jsp?searchtable1=601&amp;showdwords=true&amp;searchwordstring1=&quot;</span>

<div class="viewcode-block" id="DocumentSearchView.get_apd_link">
<a class="viewcode-back" href="../../../codedocs/corpus.html#geniza.corpus.views.DocumentSearchView.get_apd_link">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_apd_link</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate a link to the Arabic Papyrology Database (APD) search page</span>
<span class="sd">        using the entered query, converting any Hebrew script to Arabic with Regex&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">query</span> <span class="ow">or</span> <span class="ow">not</span> <span class="p">(</span><span class="n">contains_arabic</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="ow">or</span> <span class="n">contains_hebrew</span><span class="p">(</span><span class="n">query</span><span class="p">)):</span>
            <span class="c1"># if no arabic OR hebrew in query, bail out</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="c1"># simplified version of ja_to_arabic that uses regex instead of solr OR</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ja_arabic_chars</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
                <span class="c1"># list means there is more than one option, so join options with regex</span>
                <span class="n">query</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
                <span class="c1"># only one possible translation</span>
                <span class="n">query</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">apd_base_url</span><span class="si">}{</span><span class="n">query</span><span class="si">}</span><span class="s2">&quot;</span></div>


<div class="viewcode-block" id="DocumentSearchView.get_context_data">
<a class="viewcode-back" href="../../../codedocs/corpus.html#geniza.corpus.views.DocumentSearchView.get_context_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;extend context data to add page metadata, highlighting,</span>
<span class="sd">        and update form with facets&quot;&quot;&quot;</span>
        <span class="n">context_data</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">paged_result</span> <span class="o">=</span> <span class="n">context_data</span><span class="p">[</span><span class="s2">&quot;page_obj&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">object_list</span>
        <span class="n">highlights</span> <span class="o">=</span> <span class="n">paged_result</span><span class="o">.</span><span class="n">get_highlighting</span><span class="p">()</span> <span class="k">if</span> <span class="n">paged_result</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="n">facet_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">queryset</span><span class="o">.</span><span class="n">get_facets</span><span class="p">()</span>
        <span class="c1"># populate choices for facet filter fields on the form</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">context_data</span><span class="p">[</span><span class="s2">&quot;form&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_choices_from_facets</span><span class="p">(</span><span class="n">facet_dict</span><span class="o">.</span><span class="n">facet_fields</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="c1"># in the event of a solr error (which causes an AttributeError on facet_dict),</span>
            <span class="c1"># reset queryset to none() so we can display facet fields</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">queryset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">queryset</span><span class="o">.</span><span class="n">none</span><span class="p">()</span>
            <span class="n">facet_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">queryset</span><span class="o">.</span><span class="n">get_facets</span><span class="p">()</span>
            <span class="n">context_data</span><span class="p">[</span><span class="s2">&quot;form&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_choices_from_facets</span><span class="p">(</span><span class="n">facet_dict</span><span class="o">.</span><span class="n">facet_fields</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mode&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;regex&quot;</span><span class="p">:</span>
                <span class="n">context_data</span><span class="p">[</span><span class="s2">&quot;form&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">add_error</span><span class="p">(</span>
                    <span class="s2">&quot;q&quot;</span><span class="p">,</span>
                    <span class="c1"># Translators: General error text for regular expression errors</span>
                    <span class="n">_</span><span class="p">(</span>
                        <span class="s2">&quot;Error retrieving search results. Check regular expression for errors such as unescaped or unclosed brackets or parentheses.&quot;</span>
                    <span class="p">),</span>
                <span class="p">)</span>
        <span class="n">context_data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;highlighting&quot;</span><span class="p">:</span> <span class="n">highlights</span><span class="p">,</span>
                <span class="s2">&quot;page_description&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">page_description</span><span class="p">,</span>
                <span class="s2">&quot;page_title&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">page_title</span><span class="p">,</span>
                <span class="s2">&quot;page_type&quot;</span><span class="p">:</span> <span class="s2">&quot;search&quot;</span><span class="p">,</span>
                <span class="s2">&quot;page_includes_transcriptions&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>  <span class="c1"># preload transcription font</span>
                <span class="s2">&quot;highlighting&quot;</span><span class="p">:</span> <span class="n">highlights</span><span class="p">,</span>
                <span class="s2">&quot;applied_filters&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">applied_filter_labels</span><span class="p">,</span>
                <span class="s2">&quot;apd_link&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_apd_link</span><span class="p">(</span><span class="n">context_data</span><span class="p">[</span><span class="s2">&quot;form&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)),</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">context_data</span></div>
</div>



<div class="viewcode-block" id="DocumentDetailBase">
<a class="viewcode-back" href="../../../codedocs/corpus.html#geniza.corpus.views.DocumentDetailBase">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DocumentDetailBase</span><span class="p">(</span><span class="n">SolrLastModifiedMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;View mixin to handle lastmodified and redirects for documents with old PGPIDs.</span>
<span class="sd">    Overrides get request in the case of a 404, looking for any records</span>
<span class="sd">    with passed PGPID in old_pgpids, and if found, redirects to that document</span>
<span class="sd">    with current PGPID.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="DocumentDetailBase.get">
<a class="viewcode-back" href="../../../codedocs/corpus.html#geniza.corpus.views.DocumentDetailBase.get">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;extend GET to check for old pgpid and redirect on 404&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">Http404</span><span class="p">:</span>
            <span class="c1"># if not found, check for a match on a past PGPID</span>
            <span class="n">doc</span> <span class="o">=</span> <span class="n">Document</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">old_pgpids__contains</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;pk&quot;</span><span class="p">]]</span>
            <span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
            <span class="c1"># if found, redirect to the correct url for this view</span>
            <span class="k">if</span> <span class="n">doc</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;pk&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">pk</span>
                <span class="k">return</span> <span class="n">HttpResponsePermanentRedirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_absolute_url</span><span class="p">())</span>
            <span class="c1"># otherwise, continue raising the 404</span>
            <span class="k">raise</span></div>


<div class="viewcode-block" id="DocumentDetailBase.get_solr_lastmodified_filters">
<a class="viewcode-back" href="../../../codedocs/corpus.html#geniza.corpus.views.DocumentDetailBase.get_solr_lastmodified_filters">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_solr_lastmodified_filters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Filter solr last modified query by pgpid&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;pgpid_i&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;pk&quot;</span><span class="p">],</span> <span class="s2">&quot;item_type_s&quot;</span><span class="p">:</span> <span class="s2">&quot;document&quot;</span><span class="p">}</span></div>
</div>



<div class="viewcode-block" id="DocumentDetailView">
<a class="viewcode-back" href="../../../codedocs/corpus.html#geniza.corpus.views.DocumentDetailView">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DocumentDetailView</span><span class="p">(</span><span class="n">DocumentDetailBase</span><span class="p">,</span> <span class="n">DetailView</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;public display of a single :class:`~geniza.corpus.models.Document`&quot;&quot;&quot;</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">Document</span>
    <span class="n">context_object_name</span> <span class="o">=</span> <span class="s2">&quot;document&quot;</span>
    <span class="c1">#: bound name of this view, for use in generating absolute url for redirect</span>
    <span class="n">viewname</span> <span class="o">=</span> <span class="s2">&quot;corpus:document&quot;</span>

<div class="viewcode-block" id="DocumentDetailView.page_title">
<a class="viewcode-back" href="../../../codedocs/corpus.html#geniza.corpus.views.DocumentDetailView.page_title">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">page_title</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;page title, for metadata; uses document title&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span><span class="o">.</span><span class="n">title</span></div>


<div class="viewcode-block" id="DocumentDetailView.page_description">
<a class="viewcode-back" href="../../../codedocs/corpus.html#geniza.corpus.views.DocumentDetailView.page_description">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">page_description</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;page description, for metadata; uses truncated document description&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Truncator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span><span class="o">.</span><span class="n">description</span><span class="p">)</span><span class="o">.</span><span class="n">words</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span></div>


<div class="viewcode-block" id="DocumentDetailView.get_queryset">
<a class="viewcode-back" href="../../../codedocs/corpus.html#geniza.corpus.views.DocumentDetailView.get_queryset">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Don&#39;t show document if it isn&#39;t public&quot;&quot;&quot;</span>
        <span class="n">queryset</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">queryset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">Document</span><span class="o">.</span><span class="n">PUBLIC</span><span class="p">)</span></div>


<div class="viewcode-block" id="DocumentDetailView.get_context_data">
<a class="viewcode-back" href="../../../codedocs/corpus.html#geniza.corpus.views.DocumentDetailView.get_context_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;extend context data to add page metadata&quot;&quot;&quot;</span>
        <span class="n">context_data</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">images</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="n">iiif_images</span><span class="p">(</span><span class="n">with_placeholders</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># collect available panels</span>
        <span class="n">available_panels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="n">available_digital_content</span>

        <span class="n">context_data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;page_title&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">page_title</span><span class="p">(),</span>
                <span class="s2">&quot;page_description&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">page_description</span><span class="p">(),</span>
                <span class="s2">&quot;page_type&quot;</span><span class="p">:</span> <span class="s2">&quot;document&quot;</span><span class="p">,</span>
                <span class="c1"># preload transcription font when appropriate</span>
                <span class="s2">&quot;page_includes_transcriptions&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="n">has_transcription</span><span class="p">(),</span>
                <span class="c1"># generate list of related documents that can be filtered by image url for links on excluded images</span>
                <span class="s2">&quot;related_documents&quot;</span><span class="p">:</span> <span class="p">(</span>
                    <span class="p">[</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;document&quot;</span><span class="p">:</span> <span class="n">doc</span><span class="p">,</span>
                            <span class="s2">&quot;images&quot;</span><span class="p">:</span> <span class="p">[</span>
                                <span class="c1"># TODO: can we use canvas uris here instead?</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;iiif_images&quot;</span><span class="p">,</span> <span class="p">[])</span>
                            <span class="p">],</span>
                        <span class="p">}</span>
                        <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="n">related_documents</span>
                    <span class="p">]</span>
                    <span class="c1"># skip solr query if none of the associated TextBlocks have side info</span>
                    <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">tb</span><span class="o">.</span><span class="n">side</span> <span class="k">for</span> <span class="n">tb</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="n">textblock_set</span><span class="o">.</span><span class="n">all</span><span class="p">()])</span>
                    <span class="k">else</span> <span class="p">[]</span>
                <span class="p">),</span>
                <span class="s2">&quot;images&quot;</span><span class="p">:</span> <span class="n">images</span><span class="p">,</span>
                <span class="c1"># first image for twitter/opengraph meta tags</span>
                <span class="s2">&quot;meta_image&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">images</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;image&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">images</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="c1"># show all available panels by default</span>
                <span class="s2">&quot;default_shown&quot;</span><span class="p">:</span> <span class="n">available_panels</span><span class="p">,</span>
                <span class="c1"># disable any fully unavailable panels</span>
                <span class="s2">&quot;disabled&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="n">panel</span>
                    <span class="k">for</span> <span class="n">panel</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;images&quot;</span><span class="p">,</span> <span class="s2">&quot;translation&quot;</span><span class="p">,</span> <span class="s2">&quot;transcription&quot;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">panel</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">available_panels</span>
                <span class="p">],</span>
                <span class="c1"># related entities: sorted by type for grouping, and slug for alphabetization</span>
                <span class="s2">&quot;related_people&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="n">persondocumentrelation_set</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span>
                    <span class="s2">&quot;type__name&quot;</span><span class="p">,</span> <span class="s2">&quot;person__slug&quot;</span>
                <span class="p">),</span>
                <span class="s2">&quot;related_places&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="n">documentplacerelation_set</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span>
                    <span class="s2">&quot;type__name&quot;</span><span class="p">,</span> <span class="s2">&quot;place__slug&quot;</span>
                <span class="p">),</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">context_data</span></div>


<div class="viewcode-block" id="DocumentDetailView.get_absolute_url">
<a class="viewcode-back" href="../../../codedocs/corpus.html#geniza.corpus.views.DocumentDetailView.get_absolute_url">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_absolute_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the permalink to this page.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">absolutize_url</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">viewname</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;pk&quot;</span><span class="p">]]))</span></div>
</div>



<div class="viewcode-block" id="DocumentScholarshipView">
<a class="viewcode-back" href="../../../codedocs/corpus.html#geniza.corpus.views.DocumentScholarshipView">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DocumentScholarshipView</span><span class="p">(</span><span class="n">DocumentDetailView</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;List of :class:`~geniza.footnotes.models.Footnote`</span>
<span class="sd">    references for a single :class:`~geniza.corpus.models.Document`&quot;&quot;&quot;</span>

    <span class="n">template_name</span> <span class="o">=</span> <span class="s2">&quot;corpus/document_scholarship.html&quot;</span>
    <span class="n">viewname</span> <span class="o">=</span> <span class="s2">&quot;corpus:document-scholarship&quot;</span>

<div class="viewcode-block" id="DocumentScholarshipView.page_title">
<a class="viewcode-back" href="../../../codedocs/corpus.html#geniza.corpus.views.DocumentScholarshipView.page_title">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">page_title</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Translators: title of document scholarship page</span>
        <span class="k">return</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Scholarship on </span><span class="si">%(doc)s</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="p">{</span><span class="s2">&quot;doc&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span><span class="o">.</span><span class="n">title</span><span class="p">}</span></div>


<div class="viewcode-block" id="DocumentScholarshipView.page_description">
<a class="viewcode-back" href="../../../codedocs/corpus.html#geniza.corpus.views.DocumentScholarshipView.page_description">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">page_description</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
        <span class="n">count</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">footnotes</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="c1"># Translators: description of document scholarship page, for search engines</span>
        <span class="k">return</span> <span class="n">ngettext</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">%(count)d</span><span class="s2"> scholarship record&quot;</span><span class="p">,</span>
            <span class="s2">&quot;</span><span class="si">%(count)d</span><span class="s2"> scholarship records&quot;</span><span class="p">,</span>
            <span class="n">count</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">%</span> <span class="p">{</span>
            <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="n">count</span><span class="p">,</span>
        <span class="p">}</span></div>


<div class="viewcode-block" id="DocumentScholarshipView.get_queryset">
<a class="viewcode-back" href="../../../codedocs/corpus.html#geniza.corpus.views.DocumentScholarshipView.get_queryset">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Prefetch footnotes, and don&#39;t show the page if there are none.&quot;&quot;&quot;</span>
        <span class="c1"># prefetch footnotes since we&#39;ll render all of them in the template</span>
        <span class="n">queryset</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">super</span><span class="p">()</span>
            <span class="o">.</span><span class="n">get_queryset</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="o">.</span><span class="n">prefetch_related</span><span class="p">(</span><span class="s2">&quot;footnotes&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">distinct</span><span class="p">()</span>  <span class="c1"># prevent MultipleObjectsReturned if many footnotes</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">queryset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">footnotes__isnull</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="DocumentScholarshipView.get_context_data">
<a class="viewcode-back" href="../../../codedocs/corpus.html#geniza.corpus.views.DocumentScholarshipView.get_context_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">context_data</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">context_data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;page_type&quot;</span><span class="p">:</span> <span class="s2">&quot;scholarship&quot;</span><span class="p">,</span>
                <span class="c1"># transcription font not needed on this page</span>
                <span class="s2">&quot;page_includes_transcriptions&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">context_data</span></div>
</div>



<div class="viewcode-block" id="RelatedDocumentView">
<a class="viewcode-back" href="../../../codedocs/corpus.html#geniza.corpus.views.RelatedDocumentView">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">RelatedDocumentView</span><span class="p">(</span><span class="n">DocumentDetailView</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;List of :class:`~geniza.corpus.models.Document`</span>
<span class="sd">    objects that are related to specific :class:`~geniza.corpus.models.Document`</span>
<span class="sd">    (e.g., by occuring on the same shelfmark).&quot;&quot;&quot;</span>

    <span class="n">template_name</span> <span class="o">=</span> <span class="s2">&quot;corpus/related_documents.html&quot;</span>
    <span class="n">viewname</span> <span class="o">=</span> <span class="s2">&quot;corpus:related-documents&quot;</span>

<div class="viewcode-block" id="RelatedDocumentView.page_title">
<a class="viewcode-back" href="../../../codedocs/corpus.html#geniza.corpus.views.RelatedDocumentView.page_title">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">page_title</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Translators: title of related documents page</span>
        <span class="k">return</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Related documents for </span><span class="si">%(doc)s</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="p">{</span><span class="s2">&quot;doc&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span><span class="o">.</span><span class="n">title</span><span class="p">}</span></div>


<div class="viewcode-block" id="RelatedDocumentView.page_description">
<a class="viewcode-back" href="../../../codedocs/corpus.html#geniza.corpus.views.RelatedDocumentView.page_description">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">page_description</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
        <span class="n">count</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">related_documents</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="c1"># Translators: description of related documents page, for search engines</span>
        <span class="k">return</span> <span class="n">ngettext</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">%(count)d</span><span class="s2"> related document&quot;</span><span class="p">,</span>
            <span class="s2">&quot;</span><span class="si">%(count)d</span><span class="s2"> related documents&quot;</span><span class="p">,</span>
            <span class="n">count</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">%</span> <span class="p">{</span>
            <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="n">count</span><span class="p">,</span>
        <span class="p">}</span></div>


<div class="viewcode-block" id="RelatedDocumentView.get_context_data">
<a class="viewcode-back" href="../../../codedocs/corpus.html#geniza.corpus.views.RelatedDocumentView.get_context_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
        <span class="c1"># if there are no related documents, don&#39;t serve out this page</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">doc</span><span class="o">.</span><span class="n">related_documents</span><span class="o">.</span><span class="n">count</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">Http404</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="DocumentTranscriptionText">
<a class="viewcode-back" href="../../../codedocs/corpus.html#geniza.corpus.views.DocumentTranscriptionText">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DocumentTranscriptionText</span><span class="p">(</span><span class="n">DocumentDetailView</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return transcription as plain text for download&quot;&quot;&quot;</span>

    <span class="n">viewname</span> <span class="o">=</span> <span class="s2">&quot;corpus:document-transcription-text&quot;</span>

<div class="viewcode-block" id="DocumentTranscriptionText.get">
<a class="viewcode-back" href="../../../codedocs/corpus.html#geniza.corpus.views.DocumentTranscriptionText.get">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">document</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">edition</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">digital_editions</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;transcription_pk&quot;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">shelfmark</span> <span class="o">=</span> <span class="n">slugify</span><span class="p">(</span><span class="n">document</span><span class="o">.</span><span class="n">textblock_set</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">fragment</span><span class="o">.</span><span class="n">shelfmark</span><span class="p">)</span>
            <span class="n">authors</span> <span class="o">=</span> <span class="p">[</span><span class="n">slugify</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">last_name</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">edition</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">all</span><span class="p">()]</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;PGP</span><span class="si">%d</span><span class="s2">_</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">.txt&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">document</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">shelfmark</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">authors</span><span class="p">))</span>

            <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span>
                <span class="n">edition</span><span class="o">.</span><span class="n">content_text</span><span class="p">,</span>
                <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;text/plain; charset=UTF-8&quot;</span><span class="p">,</span>
                    <span class="c1"># prompt download with filename including pgpid, shelfmark, &amp; authors</span>
                    <span class="s2">&quot;Content-Disposition&quot;</span><span class="p">:</span> <span class="s1">&#39;attachment; filename=&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">Footnote</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
            <span class="c1"># if there is no footnote, or no plain text content, return 404</span>
            <span class="k">raise</span> <span class="n">Http404</span></div>
</div>



<div class="viewcode-block" id="DocumentManifestView">
<a class="viewcode-back" href="../../../codedocs/corpus.html#geniza.corpus.views.DocumentManifestView">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DocumentManifestView</span><span class="p">(</span><span class="n">DocumentDetailView</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate a IIIF Presentation manifest for a document,</span>
<span class="sd">    incorporating available canvases and attaching transcription</span>
<span class="sd">    content via annotation.&quot;&quot;&quot;</span>

    <span class="n">viewname</span> <span class="o">=</span> <span class="s2">&quot;corpus-uris:document-manifest&quot;</span>

<div class="viewcode-block" id="DocumentManifestView.get">
<a class="viewcode-back" href="../../../codedocs/corpus.html#geniza.corpus.views.DocumentManifestView.get">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">document</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
        <span class="c1"># should 404 if no images or no transcription</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">document</span><span class="o">.</span><span class="n">has_transcription</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">document</span><span class="o">.</span><span class="n">has_image</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">Http404</span>

        <span class="n">iiif_urls</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">iiif_urls</span><span class="p">()</span>
        <span class="n">local_manifest_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_absolute_url</span><span class="p">()</span>
        <span class="n">first_canvas</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">manifest</span> <span class="o">=</span> <span class="n">iiif_utils</span><span class="o">.</span><span class="n">new_iiif_manifest</span><span class="p">()</span>
        <span class="n">manifest</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">local_manifest_id</span>
        <span class="n">manifest</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">title</span>
        <span class="c1"># we probably want other metadata as well...</span>
        <span class="n">manifest</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;PGP ID&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">document</span><span class="o">.</span><span class="n">id</span><span class="p">)}]</span>
        <span class="n">manifest</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">description</span>

        <span class="n">canvases</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># keep track of unique attributions so we can include them all</span>
        <span class="n">attributions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">iiif_urls</span><span class="p">:</span>
            <span class="c1"># NOTE: If this url fails, may raise IIIFException</span>
            <span class="n">remote_manifest</span> <span class="o">=</span> <span class="n">IIIFPresentation</span><span class="o">.</span><span class="n">from_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="c1"># CUDL attribution has some variation in tags;</span>
            <span class="c1"># would be nice to preserve tagged version,</span>
            <span class="c1"># for now, ignore tags so we can easily de-dupe</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">attributions</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">strip_tags</span><span class="p">(</span><span class="n">remote_manifest</span><span class="o">.</span><span class="n">attribution</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="c1"># attribution is optional, so ignore if not present</span>
                <span class="k">pass</span>

            <span class="c1"># respect image order override if present</span>
            <span class="n">ordered_canvases</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">document</span><span class="o">.</span><span class="n">image_overrides</span><span class="p">:</span>
                <span class="c1"># order returned images according to override: first, sort overrides by &quot;order&quot;</span>
                <span class="n">sorted_overrides</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
                    <span class="n">document</span><span class="o">.</span><span class="n">image_overrides</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span>
                    <span class="c1"># get order if present; use ∞ as fallback to sort unordered to end of list</span>
                    <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;order&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)),</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">canvas_id</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">sorted_overrides</span><span class="p">:</span>
                    <span class="n">matches</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">c</span>
                        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">remote_manifest</span><span class="o">.</span><span class="n">sequences</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">canvases</span>
                        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">canvas_id</span>
                    <span class="p">]</span>
                    <span class="k">if</span> <span class="n">matches</span><span class="p">:</span>
                        <span class="n">ordered_canvases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">matches</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ordered_canvases</span> <span class="o">=</span> <span class="n">remote_manifest</span><span class="o">.</span><span class="n">sequences</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">canvases</span>

            <span class="k">for</span> <span class="n">canvas</span> <span class="ow">in</span> <span class="n">ordered_canvases</span><span class="p">:</span>
                <span class="c1"># do we want local canvas id, or rely on remote id?</span>
                <span class="n">local_canvas</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">canvas</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">first_canvas</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">first_canvas</span> <span class="o">=</span> <span class="n">local_canvas</span>
                <span class="c1"># TODO: can we build this from djiffy canvas?</span>

                <span class="c1"># adding provenance per recommendation from folks on IIIf Slack</span>
                <span class="c1"># to track original source of this canvas</span>
                <span class="n">local_canvas</span><span class="p">[</span><span class="s2">&quot;partOf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;@id&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">remote_manifest</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
                        <span class="s2">&quot;@type&quot;</span><span class="p">:</span> <span class="s2">&quot;sc:Manifest&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s2">&quot;en&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;original source: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">remote_manifest</span><span class="o">.</span><span class="n">label</span><span class="p">]</span>
                        <span class="p">},</span>
                    <span class="p">}</span>
                <span class="p">]</span>

                <span class="c1"># NOTE: would be nice to attach the annotation list to every canvas,</span>
                <span class="c1"># so transcription will be available with any page,</span>
                <span class="c1"># but canvas id needs to match annotation target</span>
                <span class="n">canvases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">local_canvas</span><span class="p">)</span>

        <span class="n">manifest</span><span class="o">.</span><span class="n">sequences</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;@type&quot;</span><span class="p">:</span> <span class="s2">&quot;sc:Sequence&quot;</span><span class="p">,</span> <span class="s2">&quot;canvases&quot;</span><span class="p">:</span> <span class="n">canvases</span><span class="p">}]</span>
        <span class="c1"># TODO: add a PGP logo here? combine logos?</span>
        <span class="c1"># NOTE: multiple logos do not seem to work with iiif presentation 2.0;</span>
        <span class="c1"># (or at least, do not display in Mirador)</span>
        <span class="c1"># in 3.0 we can use multiple provider blocks, but no viewer supports it yet</span>

        <span class="n">manifest</span><span class="o">.</span><span class="n">attribution</span> <span class="o">=</span> <span class="n">corpus_extras</span><span class="o">.</span><span class="n">format_attribution</span><span class="p">(</span><span class="n">document</span><span class="o">.</span><span class="n">attribution</span><span class="p">())</span>

        <span class="c1"># if transcription is available, add an annotation list to first canvas</span>
        <span class="k">if</span> <span class="n">document</span><span class="o">.</span><span class="n">has_transcription</span><span class="p">():</span>
            <span class="n">other_content</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;@context&quot;</span><span class="p">:</span> <span class="s2">&quot;http://iiif.io/api/presentation/2/context.json&quot;</span><span class="p">,</span>
                <span class="s2">&quot;@id&quot;</span><span class="p">:</span> <span class="n">absolutize_url</span><span class="p">(</span>
                    <span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;corpus-uris:document-annotations&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">document</span><span class="o">.</span><span class="n">pk</span><span class="p">]),</span>
                    <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">,</span>  <span class="c1"># request is needed to avoid getting https:// urls in dev</span>
                <span class="p">),</span>
                <span class="s2">&quot;@type&quot;</span><span class="p">:</span> <span class="s2">&quot;sc:AnnotationList&quot;</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="c1"># if there are no images available, use an empty canvas</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">first_canvas</span><span class="p">:</span>
                <span class="n">first_canvas</span> <span class="o">=</span> <span class="n">iiif_utils</span><span class="o">.</span><span class="n">empty_iiif_canvas</span><span class="p">()</span>
                <span class="n">canvases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">first_canvas</span><span class="p">)</span>

            <span class="c1"># attach annotation list</span>
            <span class="n">first_canvas</span><span class="p">[</span><span class="s2">&quot;otherContent&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">other_content</span>

        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">manifest</span><span class="p">),</span> <span class="n">encoder</span><span class="o">=</span><span class="n">iiif_utils</span><span class="o">.</span><span class="n">AttrDictEncoder</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="DocumentAnnotationListView">
<a class="viewcode-back" href="../../../codedocs/corpus.html#geniza.corpus.views.DocumentAnnotationListView">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DocumentAnnotationListView</span><span class="p">(</span><span class="n">DocumentDetailView</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate a IIIF Annotation List for a document to make transcription</span>
<span class="sd">    content available for inclusion in local IIIF manifest.&quot;&quot;&quot;</span>

    <span class="n">viewname</span> <span class="o">=</span> <span class="s2">&quot;corpus-uris:document-annotations&quot;</span>

<div class="viewcode-block" id="DocumentAnnotationListView.get">
<a class="viewcode-back" href="../../../codedocs/corpus.html#geniza.corpus.views.DocumentAnnotationListView.get">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;handle GET request: construct and return JSON annotation list&quot;&quot;&quot;</span>
        <span class="n">document</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
        <span class="n">digital_editions</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">digital_editions</span><span class="p">()</span>
        <span class="c1"># if there is no transcription content, 404</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">digital_editions</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Http404</span>

        <span class="c1"># get absolute url for the current page to use as annotation list id</span>
        <span class="n">annotation_list_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_absolute_url</span><span class="p">()</span>
        <span class="c1"># create outer annotation list structure</span>
        <span class="n">annotation_list</span> <span class="o">=</span> <span class="n">iiif_utils</span><span class="o">.</span><span class="n">new_annotation_list</span><span class="p">()</span>
        <span class="n">annotation_list</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">annotation_list_id</span>
        <span class="c1"># for now, annotate the first canvas</span>
        <span class="c1"># get a list of djiffy manifests</span>
        <span class="n">manifests</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">b</span><span class="o">.</span><span class="n">fragment</span><span class="o">.</span><span class="n">manifest</span>
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">document</span><span class="o">.</span><span class="n">textblock_set</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">fragment</span><span class="o">.</span><span class="n">iiif_url</span>
        <span class="p">]</span>
        <span class="n">canvas</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">manifests</span> <span class="ow">and</span> <span class="n">manifests</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">canvas</span> <span class="o">=</span> <span class="n">manifests</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">canvases</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="c1"># fallback to loading the remote manifest; (is this needed?)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">canvas</span><span class="p">:</span>
            <span class="n">iiif_urls</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">iiif_urls</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">iiif_urls</span><span class="p">:</span>
                <span class="c1"># NOTE: If this url fails, may raise IIIFException</span>
                <span class="n">manifest</span> <span class="o">=</span> <span class="n">IIIFPresentation</span><span class="o">.</span><span class="n">from_url</span><span class="p">(</span><span class="n">iiif_urls</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">canvas</span> <span class="o">=</span> <span class="n">manifest</span><span class="o">.</span><span class="n">sequences</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">canvases</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># if there are no images available, use an empty canvas</span>
                <span class="n">canvas</span> <span class="o">=</span> <span class="n">iiif_utils</span><span class="o">.</span><span class="n">empty_iiif_canvas</span><span class="p">()</span>

        <span class="n">resources</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">digital_editions</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">digital_editions</span><span class="p">()</span>
        <span class="c1"># handle multiple transcriptions</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">transcription</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">digital_editions</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">annotation</span> <span class="o">=</span> <span class="p">{</span>
                <span class="c1"># uri for this annotation; base on annotation list uri</span>
                <span class="s2">&quot;@id&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">#</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">annotation_list_id</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span>
                <span class="s2">&quot;@type&quot;</span><span class="p">:</span> <span class="s2">&quot;oa:Annotation&quot;</span><span class="p">,</span>
                <span class="s2">&quot;motivation&quot;</span><span class="p">:</span> <span class="s2">&quot;sc:painting&quot;</span><span class="p">,</span>
                <span class="c1"># transcribing should be a supported motivation (maybe 3.0?);</span>
                <span class="c1"># but mirador does not displayit</span>
                <span class="c1"># &quot;motivation&quot;: &quot;sc:transcribing&quot;,</span>
                <span class="s2">&quot;resource&quot;</span><span class="p">:</span> <span class="n">transcription</span><span class="o">.</span><span class="n">iiif_annotation_content</span><span class="p">(),</span>
                <span class="c1"># annotate the entire canvas for now</span>
                <span class="s2">&quot;on&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">#xywh=0,0,</span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">canvas</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">canvas</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">canvas</span><span class="o">.</span><span class="n">height</span><span class="p">),</span>
            <span class="p">}</span>
            <span class="n">resources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">annotation</span><span class="p">)</span>

        <span class="n">annotation_list</span><span class="p">[</span><span class="s2">&quot;resources&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resources</span>

        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">annotation_list</span><span class="p">),</span> <span class="n">encoder</span><span class="o">=</span><span class="n">iiif_utils</span><span class="o">.</span><span class="n">AttrDictEncoder</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="DocumentMerge">
<a class="viewcode-back" href="../../../codedocs/corpus.html#geniza.corpus.views.DocumentMerge">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DocumentMerge</span><span class="p">(</span><span class="n">PermissionRequiredMixin</span><span class="p">,</span> <span class="n">FormView</span><span class="p">):</span>
    <span class="n">permission_required</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;corpus.change_document&quot;</span><span class="p">,</span> <span class="s2">&quot;corpus.delete_document&quot;</span><span class="p">)</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">DocumentMergeForm</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s2">&quot;admin/corpus/document/merge.html&quot;</span>

<div class="viewcode-block" id="DocumentMerge.get_success_url">
<a class="viewcode-back" href="../../../codedocs/corpus.html#geniza.corpus.views.DocumentMerge.get_success_url">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_success_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;admin:corpus_document_change&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_document</span><span class="o">.</span><span class="n">id</span><span class="p">])</span></div>


<div class="viewcode-block" id="DocumentMerge.get_form_kwargs">
<a class="viewcode-back" href="../../../codedocs/corpus.html#geniza.corpus.views.DocumentMerge.get_form_kwargs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_form_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">form_kwargs</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">DocumentMerge</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_form_kwargs</span><span class="p">()</span>
        <span class="n">form_kwargs</span><span class="p">[</span><span class="s2">&quot;document_ids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_ids</span>
        <span class="k">return</span> <span class="n">form_kwargs</span></div>


<div class="viewcode-block" id="DocumentMerge.get_initial">
<a class="viewcode-back" href="../../../codedocs/corpus.html#geniza.corpus.views.DocumentMerge.get_initial">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_initial</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Default to first document selected</span>
        <span class="n">document_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ids&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">document_ids</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">document_ids</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span> <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">document_ids</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)]</span>
            <span class="c1"># by default, prefer the first record created</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;primary_document&quot;</span><span class="p">:</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">document_ids</span><span class="p">)[</span><span class="mi">0</span><span class="p">]}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">document_ids</span> <span class="o">=</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="DocumentMerge.form_valid">
<a class="viewcode-back" href="../../../codedocs/corpus.html#geniza.corpus.views.DocumentMerge.form_valid">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Merge the selected documents into the primary document.&quot;&quot;&quot;</span>
        <span class="n">primary_doc</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s2">&quot;primary_document&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">primary_document</span> <span class="o">=</span> <span class="n">primary_doc</span>

        <span class="c1"># Include additional notes in rationale string if present</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s2">&quot;rationale&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;other&quot;</span><span class="p">:</span>
            <span class="c1"># Only use the additional notes if &quot;other&quot; is chosen</span>
            <span class="n">rationale</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s2">&quot;rationale_notes&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s2">&quot;rationale_notes&quot;</span><span class="p">]:</span>
            <span class="n">rationale</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s2">&quot;rationale&quot;</span><span class="p">],</span>
                <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s2">&quot;rationale_notes&quot;</span><span class="p">],</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rationale</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s2">&quot;rationale&quot;</span><span class="p">]</span>

        <span class="n">secondary_ids</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">doc_id</span> <span class="k">for</span> <span class="n">doc_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_ids</span> <span class="k">if</span> <span class="n">doc_id</span> <span class="o">!=</span> <span class="n">primary_doc</span><span class="o">.</span><span class="n">id</span>
        <span class="p">]</span>
        <span class="n">secondary_docs</span> <span class="o">=</span> <span class="n">Document</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id__in</span><span class="o">=</span><span class="n">secondary_ids</span><span class="p">)</span>

        <span class="c1"># Get document strings before they are merged</span>
        <span class="n">primary_doc_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;PGPID </span><span class="si">{</span><span class="n">primary_doc</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">secondary_doc_str</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;PGPID </span><span class="si">{</span><span class="n">doc</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">secondary_docs</span><span class="p">])</span>

        <span class="c1"># Merge secondary documents into the selected primary document</span>
        <span class="n">user</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">primary_doc</span><span class="o">.</span><span class="n">merge_with</span><span class="p">(</span><span class="n">secondary_docs</span><span class="p">,</span> <span class="n">rationale</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="c1"># in case the merge resulted in an error, display error to user</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="n">err</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
            <span class="c1"># redirect to this form page instead of one of the documents</span>
            <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">?ids=</span><span class="si">%s</span><span class="s2">&quot;</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;admin:document-merge&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ids&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)),</span>
            <span class="p">)</span>

        <span class="c1"># Display info about the merge to the user</span>
        <span class="n">new_doc_link</span> <span class="o">=</span> <span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;admin:corpus_document_change&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">primary_doc</span><span class="o">.</span><span class="n">id</span><span class="p">])</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span>
            <span class="n">mark_safe</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Successfully merged document(s) </span><span class="si">{</span><span class="n">secondary_doc_str</span><span class="si">}</span><span class="s2"> with </span><span class="si">{</span><span class="n">primary_doc_str</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">DocumentMerge</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">form_valid</span><span class="p">(</span><span class="n">form</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="SourceAutocompleteView">
<a class="viewcode-back" href="../../../codedocs/corpus.html#geniza.corpus.views.SourceAutocompleteView">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">SourceAutocompleteView</span><span class="p">(</span><span class="n">PermissionRequiredMixin</span><span class="p">,</span> <span class="n">autocomplete</span><span class="o">.</span><span class="n">Select2QuerySetView</span><span class="p">):</span>
    <span class="n">permission_required</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;corpus.change_document&quot;</span><span class="p">,)</span>

<div class="viewcode-block" id="SourceAutocompleteView.get_queryset">
<a class="viewcode-back" href="../../../codedocs/corpus.html#geniza.corpus.views.SourceAutocompleteView.get_queryset">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;sources filtered by entered query, or all sources, ordered by author last name&quot;&quot;&quot;</span>
        <span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="n">Source</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;authors__last_name&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">q</span><span class="p">:</span>
            <span class="n">qs</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">qs</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
                    <span class="c1"># ArrayAgg to group together related values from related model instances</span>
                    <span class="n">authors_last</span><span class="o">=</span><span class="n">ArrayAgg</span><span class="p">(</span><span class="s2">&quot;authors__last_name&quot;</span><span class="p">,</span> <span class="n">distinct</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                    <span class="n">authors_first</span><span class="o">=</span><span class="n">ArrayAgg</span><span class="p">(</span><span class="s2">&quot;authors__first_name&quot;</span><span class="p">,</span> <span class="n">distinct</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                    <span class="c1"># PostgreSQL search vector to search across combined fields</span>
                    <span class="n">search</span><span class="o">=</span><span class="n">SearchVector</span><span class="p">(</span>
                        <span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;authors_last&quot;</span><span class="p">,</span> <span class="s2">&quot;authors_first&quot;</span><span class="p">,</span> <span class="s2">&quot;volume&quot;</span>
                    <span class="p">),</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">search</span><span class="o">=</span><span class="n">q</span><span class="p">)</span>
                <span class="o">.</span><span class="n">distinct</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">qs</span></div>
</div>



<div class="viewcode-block" id="DocumentAddTranscriptionView">
<a class="viewcode-back" href="../../../codedocs/corpus.html#geniza.corpus.views.DocumentAddTranscriptionView">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DocumentAddTranscriptionView</span><span class="p">(</span><span class="n">PermissionRequiredMixin</span><span class="p">,</span> <span class="n">DetailView</span><span class="p">):</span>
    <span class="n">permission_required</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;corpus.change_document&quot;</span><span class="p">,)</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s2">&quot;corpus/add_transcription_source.html&quot;</span>
    <span class="n">viewname</span> <span class="o">=</span> <span class="s2">&quot;corpus:document-add-transcription&quot;</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Document</span>
    <span class="n">doc_relation</span> <span class="o">=</span> <span class="s2">&quot;transcription&quot;</span>

<div class="viewcode-block" id="DocumentAddTranscriptionView.page_title">
<a class="viewcode-back" href="../../../codedocs/corpus.html#geniza.corpus.views.DocumentAddTranscriptionView.page_title">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">page_title</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Title of add transcription/translation page&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;Add a new </span><span class="si">%(doc_relation)s</span><span class="s2"> for </span><span class="si">%(doc)s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">{</span>
            <span class="s2">&quot;doc_relation&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">doc_relation</span><span class="p">,</span>
            <span class="s2">&quot;doc&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
        <span class="p">}</span></div>


<div class="viewcode-block" id="DocumentAddTranscriptionView.post">
<a class="viewcode-back" href="../../../codedocs/corpus.html#geniza.corpus.views.DocumentAddTranscriptionView.post">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create footnote linking source to document, then redirect to edit transcription/translation view&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span>
            <span class="n">reverse</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="s2">&quot;corpus:document-transcribe&quot;</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">doc_relation</span> <span class="o">==</span> <span class="s2">&quot;transcription&quot;</span>
                    <span class="k">else</span> <span class="s2">&quot;corpus:document-translate&quot;</span>
                <span class="p">),</span>
                <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">])),</span>
            <span class="p">)</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="DocumentAddTranscriptionView.get_context_data">
<a class="viewcode-back" href="../../../codedocs/corpus.html#geniza.corpus.views.DocumentAddTranscriptionView.get_context_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pass form with autocomplete to context&quot;&quot;&quot;</span>
        <span class="n">context_data</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">context_data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;form&quot;</span><span class="p">:</span> <span class="n">SourceChoiceForm</span><span class="p">,</span>
                <span class="s2">&quot;page_title&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">page_title</span><span class="p">(),</span>
                <span class="s2">&quot;page_type&quot;</span><span class="p">:</span> <span class="s2">&quot;addsource&quot;</span><span class="p">,</span>
                <span class="s2">&quot;doc_relation&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">doc_relation</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">context_data</span></div>
</div>



<div class="viewcode-block" id="DocumentTranscribeView">
<a class="viewcode-back" href="../../../codedocs/corpus.html#geniza.corpus.views.DocumentTranscribeView">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DocumentTranscribeView</span><span class="p">(</span><span class="n">PermissionRequiredMixin</span><span class="p">,</span> <span class="n">DocumentDetailView</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;View for the Transcription/Translation Editor page that uses annotorious-tahqiq&quot;&quot;&quot;</span>

    <span class="n">permission_required</span> <span class="o">=</span> <span class="s2">&quot;corpus.change_document&quot;</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s2">&quot;corpus/document_transcribe.html&quot;</span>
    <span class="n">viewname</span> <span class="o">=</span> <span class="s2">&quot;corpus:document-transcribe&quot;</span>
    <span class="n">doc_relation</span> <span class="o">=</span> <span class="s2">&quot;transcription&quot;</span>

<div class="viewcode-block" id="DocumentTranscribeView.page_title">
<a class="viewcode-back" href="../../../codedocs/corpus.html#geniza.corpus.views.DocumentTranscribeView.page_title">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">page_title</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Title of transcription/translation editor page&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;Edit </span><span class="si">%(doc_relation)s</span><span class="s2"> for </span><span class="si">%(doc)s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">{</span>
            <span class="s2">&quot;doc_relation&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">doc_relation</span><span class="p">,</span>
            <span class="s2">&quot;doc&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
        <span class="p">}</span></div>


<div class="viewcode-block" id="DocumentTranscribeView.get_context_data">
<a class="viewcode-back" href="../../../codedocs/corpus.html#geniza.corpus.views.DocumentTranscribeView.get_context_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pass annotation configuration and TinyMCE API key to page context&quot;&quot;&quot;</span>
        <span class="n">context_data</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">source</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># source_pk will always be an integer here; otherwise, a different (or no) route</span>
        <span class="c1"># would have matched</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">source</span> <span class="o">=</span> <span class="n">Source</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;source_pk&quot;</span><span class="p">])</span>
            <span class="n">source_label</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">all_authors</span><span class="p">()</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="n">source</span><span class="p">))</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">doc_relation</span> <span class="o">==</span> <span class="s2">&quot;transcription&quot;</span>
                <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">source</span><span class="o">.</span><span class="n">all_authors</span><span class="p">()</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">source</span><span class="o">.</span><span class="n">all_languages</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">Source</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Http404</span>

        <span class="c1"># per each fragment without images, pass two placeholder canvases for use in editor</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="n">textblock_set</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="n">frag_images</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">fragment</span><span class="o">.</span><span class="n">iiif_images</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">frag_images</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">canvas_base_uri</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">iiif/&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span><span class="o">.</span><span class="n">permalink</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]:</span>
                    <span class="c1"># create a placeholder canvas URI that contains textblock pk and canvas number</span>
                    <span class="n">canvas_uri</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">canvas_base_uri</span><span class="si">}</span><span class="s2">textblock/</span><span class="si">{</span><span class="n">b</span><span class="o">.</span><span class="n">pk</span><span class="si">}</span><span class="s2">/canvas/</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">/&quot;</span>
                    <span class="c1"># assign the placeholder image and appropriate labels to this canvas</span>
                    <span class="n">context_data</span><span class="p">[</span><span class="s2">&quot;images&quot;</span><span class="p">][</span><span class="n">canvas_uri</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span>
                        <span class="n">Document</span><span class="o">.</span><span class="n">PLACEHOLDER_CANVAS</span>
                    <span class="p">)</span>
                    <span class="n">context_data</span><span class="p">[</span><span class="s2">&quot;images&quot;</span><span class="p">][</span><span class="n">canvas_uri</span><span class="p">][</span>
                        <span class="s2">&quot;shelfmark&quot;</span>
                    <span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">fragment</span><span class="o">.</span><span class="n">shelfmark</span>
                    <span class="n">context_data</span><span class="p">[</span><span class="s2">&quot;images&quot;</span><span class="p">][</span><span class="n">canvas_uri</span><span class="p">][</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="s2">&quot;recto&quot;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;verso&quot;</span>
                    <span class="p">)</span>
        <span class="c1"># setup text direction for TinyMCE editor</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">doc_relation</span> <span class="o">==</span> <span class="s2">&quot;translation&quot;</span><span class="p">:</span>
            <span class="c1"># translation should use source language if possible, fallback ltr</span>
            <span class="n">text_direction</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">source</span><span class="o">.</span><span class="n">languages</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">direction</span>
                <span class="k">if</span> <span class="n">source</span> <span class="ow">and</span> <span class="n">source</span><span class="o">.</span><span class="n">languages</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
                <span class="k">else</span> <span class="s2">&quot;ltr&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># transcription always rtl</span>
            <span class="n">text_direction</span> <span class="o">=</span> <span class="s2">&quot;rtl&quot;</span>

        <span class="c1"># override show default/disabled logic from document detail view.</span>
        <span class="c1"># always show images and the panel we are editing, even if unavailable</span>
        <span class="n">default_shown</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;images&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">doc_relation</span><span class="p">]</span>
        <span class="c1"># the third panel can still be disabled (e.g. transcription when editing translation)</span>
        <span class="n">disabled</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">context_data</span><span class="p">[</span><span class="s2">&quot;disabled&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">p</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">default_shown</span><span class="p">]</span>

        <span class="n">context_data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;annotation_config&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="c1"># use local annotation server embedded in pgp application</span>
                    <span class="s2">&quot;server_url&quot;</span><span class="p">:</span> <span class="n">absolutize_url</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;annotations:list&quot;</span><span class="p">)),</span>
                    <span class="c1"># source uri for filtering, if we are editing an existing transcription</span>
                    <span class="s2">&quot;source_uri&quot;</span><span class="p">:</span> <span class="n">source</span><span class="o">.</span><span class="n">uri</span> <span class="k">if</span> <span class="n">source</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="c1"># use getattr to simplify test config; warn if not set?</span>
                    <span class="s2">&quot;manifest_base_url&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span>
                        <span class="n">settings</span><span class="p">,</span> <span class="s2">&quot;ANNOTATION_MANIFEST_BASE_URL&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
                    <span class="p">),</span>
                    <span class="s2">&quot;csrf_token&quot;</span><span class="p">:</span> <span class="n">csrf_token</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">),</span>
                    <span class="s2">&quot;tiny_api_key&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="s2">&quot;TINY_API_KEY&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                    <span class="s2">&quot;secondary_motivation&quot;</span><span class="p">:</span> <span class="p">(</span>
                        <span class="s2">&quot;transcribing&quot;</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">doc_relation</span> <span class="o">==</span> <span class="s2">&quot;transcription&quot;</span>
                        <span class="k">else</span> <span class="s2">&quot;translating&quot;</span>
                    <span class="p">),</span>
                    <span class="s2">&quot;text_direction&quot;</span><span class="p">:</span> <span class="n">text_direction</span><span class="p">,</span>
                    <span class="s2">&quot;italic_enabled&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">doc_relation</span> <span class="o">==</span> <span class="s2">&quot;translation&quot;</span><span class="p">,</span>
                    <span class="c1"># line-by-line mode for eScriptorium sourced transcriptions</span>
                    <span class="s2">&quot;line_mode&quot;</span><span class="p">:</span> <span class="s2">&quot;model&quot;</span> <span class="ow">in</span> <span class="n">source</span><span class="o">.</span><span class="n">source_type</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                    <span class="c1"># placeholder url for annotating a broken image</span>
                    <span class="s2">&quot;placeholder_img&quot;</span><span class="p">:</span> <span class="n">Document</span><span class="o">.</span><span class="n">PLACEHOLDER_CANVAS</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">][</span><span class="s2">&quot;info&quot;</span><span class="p">],</span>
                <span class="p">},</span>
                <span class="c1"># TODO: Add Footnote notes to the following display, if present</span>
                <span class="s2">&quot;source_detail&quot;</span><span class="p">:</span> <span class="p">(</span>
                    <span class="n">mark_safe</span><span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">formatted_display</span><span class="p">())</span> <span class="k">if</span> <span class="n">source</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
                <span class="p">),</span>
                <span class="s2">&quot;source_label&quot;</span><span class="p">:</span> <span class="n">source_label</span> <span class="k">if</span> <span class="n">source_label</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="s2">&quot;authors_count&quot;</span><span class="p">:</span> <span class="n">source</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="k">if</span> <span class="n">source</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;page_type&quot;</span><span class="p">:</span> <span class="s2">&quot;document annotating&quot;</span><span class="p">,</span>
                <span class="s2">&quot;disabled&quot;</span><span class="p">:</span> <span class="n">disabled</span><span class="p">,</span>
                <span class="s2">&quot;default_shown&quot;</span><span class="p">:</span> <span class="n">default_shown</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">context_data</span></div>
</div>



<div class="viewcode-block" id="TagMerge">
<a class="viewcode-back" href="../../../codedocs/corpus.html#geniza.corpus.views.TagMerge">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TagMerge</span><span class="p">(</span><span class="n">PermissionRequiredMixin</span><span class="p">,</span> <span class="n">FormView</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Class-based view for merging tags, closely adapted from DocumentMerge.&quot;&quot;&quot;</span>

    <span class="n">permission_required</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;corpus.change_document&quot;</span><span class="p">,</span>
        <span class="s2">&quot;taggit.change_tag&quot;</span><span class="p">,</span>
        <span class="s2">&quot;taggit.delete_tag&quot;</span><span class="p">,</span>
        <span class="s2">&quot;taggit.change_taggeditem&quot;</span><span class="p">,</span>
        <span class="s2">&quot;taggit.add_taggeditem&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">TagMergeForm</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s2">&quot;admin/corpus/tag/merge.html&quot;</span>

<div class="viewcode-block" id="TagMerge.get_success_url">
<a class="viewcode-back" href="../../../codedocs/corpus.html#geniza.corpus.views.TagMerge.get_success_url">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_success_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;admin:taggit_tag_change&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_tag</span><span class="o">.</span><span class="n">id</span><span class="p">])</span></div>


<div class="viewcode-block" id="TagMerge.get_form_kwargs">
<a class="viewcode-back" href="../../../codedocs/corpus.html#geniza.corpus.views.TagMerge.get_form_kwargs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_form_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">form_kwargs</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_form_kwargs</span><span class="p">()</span>
        <span class="n">form_kwargs</span><span class="p">[</span><span class="s2">&quot;tag_ids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag_ids</span>
        <span class="k">return</span> <span class="n">form_kwargs</span></div>


<div class="viewcode-block" id="TagMerge.get_initial">
<a class="viewcode-back" href="../../../codedocs/corpus.html#geniza.corpus.views.TagMerge.get_initial">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_initial</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Default to first tag selected</span>
        <span class="n">tag_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ids&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tag_ids</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tag_ids</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span> <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">tag_ids</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)]</span>
            <span class="c1"># by default, prefer the first record created</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;primary_tag&quot;</span><span class="p">:</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tag_ids</span><span class="p">)[</span><span class="mi">0</span><span class="p">]}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tag_ids</span> <span class="o">=</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="TagMerge.merge_tags">
<a class="viewcode-back" href="../../../codedocs/corpus.html#geniza.corpus.views.TagMerge.merge_tags">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">merge_tags</span><span class="p">(</span><span class="n">primary_tag</span><span class="p">,</span> <span class="n">secondary_tags</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Merge secondary_tags into primary_tag: tag all documents tagged with any of the</span>
<span class="sd">        secondary_tags with the primary_tag, then delete all secondary_tags, and record</span>
<span class="sd">        the change with a LogEntry.&quot;&quot;&quot;</span>
        <span class="c1"># add primary tag to all secondary tagged docs</span>
        <span class="n">tagged_docs</span> <span class="o">=</span> <span class="n">Document</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">tags__in</span><span class="o">=</span><span class="n">secondary_tags</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">tagged_docs</span><span class="p">:</span>
            <span class="n">doc</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">primary_tag</span><span class="p">)</span>
        <span class="c1"># create a string for the logentry, then delete all secondary tags and log</span>
        <span class="n">secondary_string</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">tag</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">secondary_tags</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">secondary_tags</span><span class="p">:</span>
            <span class="n">tag</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="n">LogEntry</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">log_action</span><span class="p">(</span>
            <span class="n">user_id</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">content_type_id</span><span class="o">=</span><span class="n">ContentType</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_for_model</span><span class="p">(</span><span class="n">Tag</span><span class="p">)</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span>
            <span class="n">object_id</span><span class="o">=</span><span class="n">primary_tag</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span>
            <span class="n">object_repr</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">primary_tag</span><span class="p">),</span>
            <span class="n">change_message</span><span class="o">=</span><span class="s2">&quot;merged with </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">secondary_string</span><span class="p">,</span>
            <span class="n">action_flag</span><span class="o">=</span><span class="n">CHANGE</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="TagMerge.form_valid">
<a class="viewcode-back" href="../../../codedocs/corpus.html#geniza.corpus.views.TagMerge.form_valid">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Merge the selected tags into the primary tag.&quot;&quot;&quot;</span>
        <span class="n">primary_tag</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s2">&quot;primary_tag&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">primary_tag</span> <span class="o">=</span> <span class="n">primary_tag</span>

        <span class="n">secondary_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">tag_id</span> <span class="k">for</span> <span class="n">tag_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag_ids</span> <span class="k">if</span> <span class="n">tag_id</span> <span class="o">!=</span> <span class="n">primary_tag</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>
        <span class="n">secondary_tags</span> <span class="o">=</span> <span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id__in</span><span class="o">=</span><span class="n">secondary_ids</span><span class="p">)</span>

        <span class="c1"># Get tag strings before they are merged</span>
        <span class="n">primary_tag_str</span> <span class="o">=</span> <span class="n">primary_tag</span><span class="o">.</span><span class="n">name</span>
        <span class="n">secondary_tag_str</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">tag</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">secondary_tags</span><span class="p">])</span>

        <span class="c1"># Merge secondary tags into the selected primary tag</span>
        <span class="n">user</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">TagMerge</span><span class="o">.</span><span class="n">merge_tags</span><span class="p">(</span><span class="n">primary_tag</span><span class="p">,</span> <span class="n">secondary_tags</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>

        <span class="c1"># Display info about the merge to the user</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span>
            <span class="n">mark_safe</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Successfully merged tag(s) </span><span class="si">{</span><span class="n">secondary_tag_str</span><span class="si">}</span><span class="s2"> into </span><span class="si">{</span><span class="n">primary_tag_str</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">form_valid</span><span class="p">(</span><span class="n">form</span><span class="p">)</span></div>
</div>



<span class="c1"># --------------- Publish CSV to sync with old PGP site --------------------- #</span>


<div class="viewcode-block" id="old_pgp_edition">
<a class="viewcode-back" href="../../../codedocs/corpus.html#geniza.corpus.views.old_pgp_edition">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">old_pgp_edition</span><span class="p">(</span><span class="n">editions</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;output footnote and source information in a format similar to</span>
<span class="sd">    old pgp metadata editor/editions.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">editions</span><span class="p">:</span>
        <span class="c1"># label as translation if edition also supplies translation;</span>
        <span class="c1"># include url if any</span>
        <span class="n">edition_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;</span><span class="si">%s%s%s</span><span class="s2">&quot;</span>
            <span class="o">%</span> <span class="p">(</span>
                <span class="s2">&quot;and trans. &quot;</span> <span class="k">if</span> <span class="n">Footnote</span><span class="o">.</span><span class="n">TRANSLATION</span> <span class="ow">in</span> <span class="n">fn</span><span class="o">.</span><span class="n">doc_relation</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="n">fn</span><span class="o">.</span><span class="n">display</span><span class="p">(</span><span class="n">old_pgp</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">),</span>
                <span class="s2">&quot; </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">fn</span><span class="o">.</span><span class="n">url</span> <span class="k">if</span> <span class="n">fn</span><span class="o">.</span><span class="n">url</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">editions</span>
        <span class="p">]</span>
        <span class="c1"># combine multiple editons as Ed. ...; also ed. ...</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;Ed. &quot;</span><span class="p">,</span> <span class="s2">&quot;; also ed. &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">edition_list</span><span class="p">),</span> <span class="s2">&quot;.&quot;</span><span class="p">])</span>

    <span class="k">return</span> <span class="s2">&quot;&quot;</span></div>



<div class="viewcode-block" id="old_pgp_tabulate_data">
<a class="viewcode-back" href="../../../codedocs/corpus.html#geniza.corpus.views.old_pgp_tabulate_data">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">old_pgp_tabulate_data</span><span class="p">(</span><span class="n">queryset</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Takes a :class:`~geniza.corpus.models.Document` queryset and</span>
<span class="sd">    yields rows of data for serialization as csv in :meth:`pgp_metadata_for_old_site`&quot;&quot;&quot;</span>
    <span class="c1"># NOTE: This logic assumes that documents will always have a fragment</span>
    <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">queryset</span><span class="p">:</span>
        <span class="n">primary_fragment</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">textblock_set</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">fragment</span>
        <span class="c1"># combined shelfmark was included in the join column previously</span>
        <span class="n">join_shelfmark</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">shelfmark</span>
        <span class="c1"># library abbreviation; use collection abbreviation as fallback</span>
        <span class="n">library</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">primary_fragment</span><span class="o">.</span><span class="n">collection</span><span class="p">:</span>
            <span class="n">library</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">primary_fragment</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">lib_abbrev</span>
                <span class="ow">or</span> <span class="n">primary_fragment</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">abbrev</span>
            <span class="p">)</span>

        <span class="k">yield</span> <span class="p">[</span>
            <span class="n">doc</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>  <span class="c1"># pgpid</span>
            <span class="n">library</span><span class="p">,</span>  <span class="c1"># library / collection</span>
            <span class="n">primary_fragment</span><span class="o">.</span><span class="n">shelfmark</span><span class="p">,</span>  <span class="c1"># shelfmark</span>
            <span class="n">primary_fragment</span><span class="o">.</span><span class="n">old_shelfmarks</span><span class="p">,</span>  <span class="c1"># shelfmark_alt</span>
            <span class="n">doc</span><span class="o">.</span><span class="n">textblock_set</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">side</span><span class="p">,</span>  <span class="c1"># recto_verso</span>
            <span class="n">doc</span><span class="o">.</span><span class="n">doctype</span><span class="p">,</span>  <span class="c1"># document type</span>
            <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="n">t</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">doc</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">all</span><span class="p">()),</span>  <span class="c1"># tags</span>
            <span class="n">join_shelfmark</span> <span class="k">if</span> <span class="s2">&quot; + &quot;</span> <span class="ow">in</span> <span class="n">join_shelfmark</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>  <span class="c1"># join</span>
            <span class="n">doc</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>  <span class="c1"># description</span>
            <span class="n">old_pgp_edition</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">editions</span><span class="p">()),</span>  <span class="c1"># editor</span>
            <span class="s2">&quot;;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">doc</span><span class="o">.</span><span class="n">old_pgpids</span><span class="p">])</span> <span class="k">if</span> <span class="n">doc</span><span class="o">.</span><span class="n">old_pgpids</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="p">]</span></div>



<div class="viewcode-block" id="pgp_metadata_for_old_site">
<a class="viewcode-back" href="../../../codedocs/corpus.html#geniza.corpus.views.pgp_metadata_for_old_site">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">pgp_metadata_for_old_site</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Stream metadata in CSV format for index and display in the old PGP site.&quot;&quot;&quot;</span>

    <span class="c1"># limit to documents with associated fragments, since the output</span>
    <span class="c1"># assumes a document has at least one frgment</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">Document</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">Document</span><span class="o">.</span><span class="n">PUBLIC</span><span class="p">,</span> <span class="n">fragments__isnull</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">distinct</span><span class="p">()</span>
        <span class="o">.</span><span class="n">select_related</span><span class="p">(</span><span class="s2">&quot;doctype&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">prefetch_related</span><span class="p">(</span>
            <span class="s2">&quot;tags&quot;</span><span class="p">,</span>
            <span class="s2">&quot;footnotes&quot;</span><span class="p">,</span>
            <span class="c1"># see corpus admin for notes on nested prefetch</span>
            <span class="n">Prefetch</span><span class="p">(</span>
                <span class="s2">&quot;textblock_set&quot;</span><span class="p">,</span>
                <span class="n">queryset</span><span class="o">=</span><span class="n">TextBlock</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">select_related</span><span class="p">(</span>
                    <span class="s2">&quot;fragment&quot;</span><span class="p">,</span> <span class="s2">&quot;fragment__collection&quot;</span>
                <span class="p">),</span>
            <span class="p">),</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="c1"># return response</span>
    <span class="k">return</span> <span class="n">export_to_csv_response</span><span class="p">(</span>
        <span class="s2">&quot;pgp_metadata.csv&quot;</span><span class="p">,</span>
        <span class="p">[</span>
            <span class="s2">&quot;pgpid&quot;</span><span class="p">,</span>
            <span class="s2">&quot;library&quot;</span><span class="p">,</span>
            <span class="s2">&quot;shelfmark&quot;</span><span class="p">,</span>
            <span class="s2">&quot;shelfmark_alt&quot;</span><span class="p">,</span>
            <span class="s2">&quot;recto_verso&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">,</span>
            <span class="s2">&quot;tags&quot;</span><span class="p">,</span>
            <span class="s2">&quot;joins&quot;</span><span class="p">,</span>
            <span class="s2">&quot;description&quot;</span><span class="p">,</span>
            <span class="s2">&quot;editor&quot;</span><span class="p">,</span>
            <span class="s2">&quot;old_pgpids&quot;</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="n">old_pgp_tabulate_data</span><span class="p">(</span><span class="n">queryset</span><span class="p">),</span>
    <span class="p">)</span></div>



<span class="c1"># --------------------------------------------------------------------------- #</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">Princeton Geniza Project</a></h1>



<p class="blurb">Django web application and other code for Princeton Geniza Project v4.x</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=Princeton-CDH&repo=geniza&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>







    

<p>
<a class="badge" href="https://codecov.io/github/Princeton-CDH/geniza">
    <img
    alt="https://codecov.io/github/Princeton-CDH/geniza/coverage.svg?branch=master"
    src="https://codecov.io/github/Princeton-CDH/geniza/coverage.svg?branch=master"
    />
</a>
</p>
<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../architecture.html">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../codedocs/index.html">Code Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../devnotes.html">Developer Instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">Change Log</a></li>
</ul>


<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><div class="powered_by">
    <p>Powered by:</p>
    <a href="http://cdh.princeton.edu/">
        <img src="https://cdh.princeton.edu/static/img/CDH_logo.svg"
            alt="Center for Digital Humanities @ Princeton" />
    </a>
</div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2022, Center for Digital Humanities @ Princeton.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 7.4.7</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
    </div>

    

    
  </body>
</html>