<!DOCTYPE html>

<html lang="en" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>geniza.footnotes.models &#8212; Princeton Geniza Project 4.16.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=d1102ebc" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css?v=12dfc556" />
    <script src="../../../_static/documentation_options.js?v=c9094266"></script>
    <script src="../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for geniza.footnotes.models</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">cached_property</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">path</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urljoin</span>

<span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>
<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.contrib.contenttypes.fields</span> <span class="kn">import</span> <span class="n">GenericForeignKey</span>
<span class="kn">from</span> <span class="nn">django.contrib.contenttypes.models</span> <span class="kn">import</span> <span class="n">ContentType</span>
<span class="kn">from</span> <span class="nn">django.contrib.humanize.templatetags.humanize</span> <span class="kn">import</span> <span class="n">ordinal</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">django.db.models</span> <span class="kn">import</span> <span class="n">Count</span>
<span class="kn">from</span> <span class="nn">django.db.models.functions</span> <span class="kn">import</span> <span class="n">NullIf</span>
<span class="kn">from</span> <span class="nn">django.db.models.query</span> <span class="kn">import</span> <span class="n">Prefetch</span>
<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">reverse</span>
<span class="kn">from</span> <span class="nn">django.utils.html</span> <span class="kn">import</span> <span class="n">strip_tags</span>
<span class="kn">from</span> <span class="nn">django.utils.translation</span> <span class="kn">import</span> <span class="n">gettext</span>
<span class="kn">from</span> <span class="nn">django.utils.translation</span> <span class="kn">import</span> <span class="n">gettext_lazy</span> <span class="k">as</span> <span class="n">_</span>
<span class="kn">from</span> <span class="nn">gfklookupwidget.fields</span> <span class="kn">import</span> <span class="n">GfkLookupField</span>
<span class="kn">from</span> <span class="nn">modeltranslation.manager</span> <span class="kn">import</span> <span class="n">MultilingualManager</span><span class="p">,</span> <span class="n">MultilingualQuerySet</span>
<span class="kn">from</span> <span class="nn">multiselectfield</span> <span class="kn">import</span> <span class="n">MultiSelectField</span>

<span class="kn">from</span> <span class="nn">geniza.common.fields</span> <span class="kn">import</span> <span class="n">NaturalSortField</span>
<span class="kn">from</span> <span class="nn">geniza.common.models</span> <span class="kn">import</span> <span class="n">TrackChangesModel</span>
<span class="kn">from</span> <span class="nn">geniza.footnotes.utils</span> <span class="kn">import</span> <span class="n">HTMLLineNumberParser</span>


<div class="viewcode-block" id="SourceType">
<a class="viewcode-back" href="../../../codedocs/footnotes.html#geniza.footnotes.models.SourceType">[docs]</a>
<span class="k">class</span> <span class="nc">SourceType</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;type of source&quot;&quot;&quot;</span>

    <span class="nb">type</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span></div>



<div class="viewcode-block" id="SourceLanguage">
<a class="viewcode-back" href="../../../codedocs/footnotes.html#geniza.footnotes.models.SourceLanguage">[docs]</a>
<span class="k">class</span> <span class="nc">SourceLanguage</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;language of a source document&quot;&quot;&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
    <span class="n">code</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;ISO language code&quot;</span><span class="p">)</span>
    <span class="n">LTR</span> <span class="o">=</span> <span class="s2">&quot;ltr&quot;</span>
    <span class="n">RTL</span> <span class="o">=</span> <span class="s2">&quot;rtl&quot;</span>
    <span class="n">DIRECTION_CHOICES</span> <span class="o">=</span> <span class="p">((</span><span class="n">LTR</span><span class="p">,</span> <span class="s2">&quot;Left to right&quot;</span><span class="p">),</span> <span class="p">(</span><span class="n">RTL</span><span class="p">,</span> <span class="s2">&quot;Right to left&quot;</span><span class="p">))</span>
    <span class="n">direction</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">LTR</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="n">DIRECTION_CHOICES</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span></div>



<div class="viewcode-block" id="CreatorManager">
<a class="viewcode-back" href="../../../codedocs/footnotes.html#geniza.footnotes.models.CreatorManager">[docs]</a>
<span class="k">class</span> <span class="nc">CreatorManager</span><span class="p">(</span><span class="n">MultilingualManager</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Custom manager for :class:`Creator` with natural key lookup&quot;&quot;&quot;</span>

<div class="viewcode-block" id="CreatorManager.get_by_natural_key">
<a class="viewcode-back" href="../../../codedocs/footnotes.html#geniza.footnotes.models.CreatorManager.get_by_natural_key">[docs]</a>
    <span class="k">def</span> <span class="nf">get_by_natural_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">last_name</span><span class="p">,</span> <span class="n">first_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;natural key lookup: based on combination of last name and first name&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">last_name</span><span class="o">=</span><span class="n">last_name</span><span class="p">,</span> <span class="n">first_name</span><span class="o">=</span><span class="n">first_name</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="Creator">
<a class="viewcode-back" href="../../../codedocs/footnotes.html#geniza.footnotes.models.Creator">[docs]</a>
<span class="k">class</span> <span class="nc">Creator</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;author or other contributor to a source&quot;&quot;&quot;</span>

    <span class="n">first_name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
    <span class="n">last_name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>

    <span class="n">objects</span> <span class="o">=</span> <span class="n">CreatorManager</span><span class="p">()</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;last_name&quot;</span><span class="p">,</span> <span class="s2">&quot;first_name&quot;</span><span class="p">]</span>
        <span class="n">constraints</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">models</span><span class="o">.</span><span class="n">UniqueConstraint</span><span class="p">(</span>
                <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;first_name&quot;</span><span class="p">,</span> <span class="s2">&quot;last_name&quot;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;creator_unique_name&quot;</span>
            <span class="p">)</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">last_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_name</span><span class="p">]</span> <span class="k">if</span> <span class="n">n</span><span class="p">])</span>

<div class="viewcode-block" id="Creator.natural_key">
<a class="viewcode-back" href="../../../codedocs/footnotes.html#geniza.footnotes.models.Creator.natural_key">[docs]</a>
    <span class="k">def</span> <span class="nf">natural_key</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;natural key: tuple of last name, first name&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_name</span><span class="p">)</span></div>


<div class="viewcode-block" id="Creator.firstname_lastname">
<a class="viewcode-back" href="../../../codedocs/footnotes.html#geniza.footnotes.models.Creator.firstname_lastname">[docs]</a>
    <span class="k">def</span> <span class="nf">firstname_lastname</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creator full name, with first name first&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">first_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_name</span><span class="p">]</span> <span class="k">if</span> <span class="n">n</span><span class="p">])</span></div>
</div>



<div class="viewcode-block" id="Authorship">
<a class="viewcode-back" href="../../../codedocs/footnotes.html#geniza.footnotes.models.Authorship">[docs]</a>
<span class="k">class</span> <span class="nc">Authorship</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ordered relationship between :class:`Creator` and :class:`Source`.&quot;&quot;&quot;</span>

    <span class="n">creator</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Creator</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;Source&quot;</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>
    <span class="n">sort_order</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveSmallIntegerField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;sort_order&quot;</span><span class="p">,)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1"> author on &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">creator</span><span class="p">,</span>
            <span class="n">ordinal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sort_order</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
        <span class="p">)</span></div>



<div class="viewcode-block" id="SourceQuerySet">
<a class="viewcode-back" href="../../../codedocs/footnotes.html#geniza.footnotes.models.SourceQuerySet">[docs]</a>
<span class="k">class</span> <span class="nc">SourceQuerySet</span><span class="p">(</span><span class="n">MultilingualQuerySet</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Custom queryset for :class:`Source`, for reusable</span>
<span class="sd">    prefetching and count annotation.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="SourceQuerySet.metadata_prefetch">
<a class="viewcode-back" href="../../../codedocs/footnotes.html#geniza.footnotes.models.SourceQuerySet.metadata_prefetch">[docs]</a>
    <span class="k">def</span> <span class="nf">metadata_prefetch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;prefetch source type and authors&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_related</span><span class="p">(</span><span class="s2">&quot;source_type&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">prefetch_related</span><span class="p">(</span>
            <span class="s2">&quot;languages&quot;</span><span class="p">,</span>
            <span class="n">Prefetch</span><span class="p">(</span>
                <span class="s2">&quot;authorship_set&quot;</span><span class="p">,</span>
                <span class="n">queryset</span><span class="o">=</span><span class="n">Authorship</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">select_related</span><span class="p">(</span><span class="s2">&quot;creator&quot;</span><span class="p">),</span>
            <span class="p">),</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="SourceQuerySet.footnote_count">
<a class="viewcode-back" href="../../../codedocs/footnotes.html#geniza.footnotes.models.SourceQuerySet.footnote_count">[docs]</a>
    <span class="k">def</span> <span class="nf">footnote_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;annotate with footnote count&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">Count</span><span class="p">(</span><span class="s2">&quot;footnote&quot;</span><span class="p">,</span> <span class="n">distinct</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span></div>
</div>



<div class="viewcode-block" id="Source">
<a class="viewcode-back" href="../../../codedocs/footnotes.html#geniza.footnotes.models.Source">[docs]</a>
<span class="k">class</span> <span class="nc">Source</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;a published or unpublished work related to geniza materials&quot;&quot;&quot;</span>

    <span class="n">authors</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span><span class="n">Creator</span><span class="p">,</span> <span class="n">through</span><span class="o">=</span><span class="n">Authorship</span><span class="p">)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">year</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveIntegerField</span><span class="p">(</span><span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">edition</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveIntegerField</span><span class="p">(</span><span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">volume</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Volume of a multivolume book, or journal volume for an article&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">issue</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveIntegerField</span><span class="p">(</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Issue number for a journal article&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">journal</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="s2">&quot;Journal / Book&quot;</span><span class="p">,</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Journal title (for an article) or book title (for a book section)&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">page_range</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Page range for article or book section.&quot;</span>
    <span class="p">)</span>
    <span class="n">publisher</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Publisher name, or degree granting institution for a dissertation&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">place_published</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Place where the work was published&quot;</span>
    <span class="p">)</span>
    <span class="n">other_info</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Additional citation information, if any&quot;</span>
    <span class="p">)</span>
    <span class="n">source_type</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span>
        <span class="n">SourceType</span><span class="p">,</span>
        <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;The form of the source&#39;s publication. Note: for unpublished sources, be sure</span>
<span class="s2">        to create separate Source records for unpublished transcriptions and unpublished</span>
<span class="s2">        translations, even if they reside on the same digital document.&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">languages</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span>
        <span class="n">SourceLanguage</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;The language(s) the source is written in. Note: The Unspecified language</span>
<span class="s2">        option should only ever be used for unpublished transcriptions, as the language of the</span>
<span class="s2">        transcription is already marked on the document.&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">URLField</span><span class="p">(</span><span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s2">&quot;URL&quot;</span><span class="p">)</span>
    <span class="c1"># preliminary place to store transcription text; should not be editable</span>
    <span class="n">notes</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">objects</span> <span class="o">=</span> <span class="n">SourceQuerySet</span><span class="o">.</span><span class="n">as_manager</span><span class="p">()</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="c1"># set default order to title, year for now since first-author order</span>
        <span class="c1"># requires queryset annotation</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Method used for for internal/data admin use.</span>
<span class="sd">        Please use the `display` or `formatted_display` methods for public display.&quot;&quot;&quot;</span>
        <span class="c1"># Append volume for unpublished</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_type</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;Unpublished&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">)</span>
        <span class="c1"># Otherwise return formatted display without html tags</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="p">()</span>

<div class="viewcode-block" id="Source.all_authors">
<a class="viewcode-back" href="../../../codedocs/footnotes.html#geniza.footnotes.models.Source.all_authors">[docs]</a>
    <span class="k">def</span> <span class="nf">all_authors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;semi-colon delimited list of authors in order&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">creator</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">authorship_set</span><span class="o">.</span><span class="n">all</span><span class="p">()])</span></div>


<div class="viewcode-block" id="Source.all_languages">
<a class="viewcode-back" href="../../../codedocs/footnotes.html#geniza.footnotes.models.Source.all_languages">[docs]</a>
    <span class="k">def</span> <span class="nf">all_languages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;comma-delimited list of languages, in parentheses, used for the translation selector&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">languages</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">return</span> <span class="s2">&quot;(in </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">lang</span><span class="p">)</span> <span class="k">for</span> <span class="n">lang</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">languages</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)]</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span></div>


<div class="viewcode-block" id="Source.formatted_display">
<a class="viewcode-back" href="../../../codedocs/footnotes.html#geniza.footnotes.models.Source.formatted_display">[docs]</a>
    <span class="k">def</span> <span class="nf">formatted_display</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">extra_fields</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Format source for display; used on document scholarship page.</span>
<span class="sd">        To omit publisher, place_published, and page_range fields,</span>
<span class="sd">        specify `extra_fields=False`.&quot;&quot;&quot;</span>

        <span class="n">author</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">authorship_set</span><span class="o">.</span><span class="n">all</span><span class="p">()):</span>
            <span class="n">author_lastnames</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">a</span><span class="o">.</span><span class="n">creator</span><span class="o">.</span><span class="n">firstname_lastname</span><span class="p">()</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">authorship_set</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="p">]</span>
            <span class="c1"># combine the last pair with and; combine all others with comma</span>
            <span class="c1"># thanks to https://stackoverflow.com/a/30084022</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">author_lastnames</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">author</span> <span class="o">=</span> <span class="s2">&quot; and &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">author_lastnames</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">author_lastnames</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">author</span> <span class="o">=</span> <span class="n">author_lastnames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">parts</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Ensure that Unicode LTR mark is added after fields when RTL languages present</span>
        <span class="n">rtl_langs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Hebrew&quot;</span><span class="p">,</span> <span class="s2">&quot;Arabic&quot;</span><span class="p">,</span> <span class="s2">&quot;Judaeo-Arabic&quot;</span><span class="p">]</span>
        <span class="n">source_langs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">lang</span><span class="p">)</span> <span class="k">for</span> <span class="n">lang</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">languages</span><span class="o">.</span><span class="n">all</span><span class="p">()]</span>
        <span class="n">source_contains_rtl</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">source_langs</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">rtl_langs</span><span class="p">))</span>
        <span class="n">ltr_mark</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">8206</span><span class="p">)</span> <span class="k">if</span> <span class="n">source_contains_rtl</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># Types that should receive double quotes around title</span>
        <span class="n">doublequoted_types</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Article&quot;</span><span class="p">,</span> <span class="s2">&quot;Dissertation&quot;</span><span class="p">,</span> <span class="s2">&quot;Book Section&quot;</span><span class="p">]</span>

        <span class="c1"># Handle title</span>
        <span class="n">work_title</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">:</span>
            <span class="c1"># if this is a book, italicize title</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_type</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;Book&quot;</span><span class="p">:</span>
                <span class="n">work_title</span> <span class="o">=</span> <span class="s2">&quot;&lt;em&gt;</span><span class="si">%s%s</span><span class="s2">&lt;/em&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="n">ltr_mark</span><span class="p">)</span>
            <span class="c1"># if this is a doublequoted type, wrap title in quotes</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_type</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="n">doublequoted_types</span><span class="p">:</span>
                <span class="n">stripped_title</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
                <span class="n">work_title</span> <span class="o">=</span> <span class="s1">&#39;&quot;</span><span class="si">%s%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">stripped_title</span><span class="p">,</span> <span class="n">ltr_mark</span><span class="p">)</span>
            <span class="c1"># if this is a machine learning model, format appropriately</span>
            <span class="k">elif</span> <span class="s2">&quot;model&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_type</span><span class="o">.</span><span class="n">type</span><span class="p">:</span>
                <span class="n">work_title</span> <span class="o">=</span> <span class="s2">&quot;Machine-generated transcription (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span>
            <span class="c1"># otherwise, just leave unformatted</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">work_title</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">+</span> <span class="n">ltr_mark</span>
        <span class="k">elif</span> <span class="n">extra_fields</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">author</span><span class="p">:</span>
            <span class="c1"># Use [digital geniza document edition] as placeholder title when no title available;</span>
            <span class="c1"># only when extra_fields enabled, or there is no author</span>

            <span class="c1"># Translators: Placeholder for when a work has no title available</span>
            <span class="n">work_title</span> <span class="o">=</span> <span class="n">gettext</span><span class="p">(</span><span class="s2">&quot;[digital geniza document edition]&quot;</span><span class="p">)</span>

        <span class="c1"># Wrap title in link to URL</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="ow">and</span> <span class="n">work_title</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&lt;a href=&quot;</span><span class="si">%s</span><span class="s1">&quot;&gt;</span><span class="si">%s</span><span class="s1">&lt;/a&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">work_title</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">work_title</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">work_title</span><span class="p">)</span>

        <span class="c1"># Add edition for Book type if present</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">edition</span><span class="p">:</span>
            <span class="n">edition_str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> ed.&quot;</span> <span class="o">%</span> <span class="n">ordinal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edition</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_type</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;Book&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">:</span>
                <span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="s2">&quot;,&quot;</span>
                <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edition_str</span><span class="p">)</span>

        <span class="c1"># Add non-English languages as parenthetical</span>
        <span class="n">included_langs</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">languages</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">lang</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">languages</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                <span class="c1"># Also prevent Unspecified from showing up in source citations</span>
                <span class="k">if</span> <span class="s2">&quot;English&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">lang</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;Unspecified&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">lang</span><span class="p">):</span>
                    <span class="n">included_langs</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;(in </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">lang</span><span class="p">)</span>

        <span class="c1"># Handling presence of book/journal title</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">journal</span><span class="p">:</span>
            <span class="c1"># add comma inside doublequotes when they are present, if no language parenthetical</span>
            <span class="c1"># examples:</span>
            <span class="c1">#   &quot;Title&quot;                 --&gt; &quot;Title,&quot;</span>
            <span class="c1">#   NOT &quot;Title&quot; (in Hebrew) --&gt; &quot;Title,&quot; (in Hebrew)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="ow">and</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">source_type</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="n">doublequoted_types</span>
                <span class="ow">and</span> <span class="ow">not</span> <span class="n">included_langs</span>  <span class="c1"># put comma after language even when doublequotes present</span>
            <span class="p">):</span>
                <span class="c1"># find rightmost doublequote</span>
                <span class="n">formatted_title</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">last_dq</span> <span class="o">=</span> <span class="n">formatted_title</span><span class="o">.</span><span class="n">rindex</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
                <span class="c1"># add comma directly before it</span>
                <span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">formatted_title</span><span class="p">[:</span><span class="n">last_dq</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="n">formatted_title</span><span class="p">[</span><span class="n">last_dq</span><span class="p">:]</span>
            <span class="c1"># otherwise, simply add the comma at the end of the title (or language)</span>
            <span class="c1"># examples:</span>
            <span class="c1">#   &lt;em&gt;Title&lt;/em&gt;      --&gt; &lt;em&gt;Title&lt;/em&gt;,</span>
            <span class="c1">#   &quot;Title&quot; (in Hebrew) --&gt; &quot;Title&quot; (in Hebrew),</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">):</span>
                <span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="s2">&quot;,&quot;</span>

            <span class="c1"># CMS needs &quot;in&quot; before book title</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_type</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;Book Section&quot;</span><span class="p">:</span>
                <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;in&quot;</span><span class="p">)</span>

            <span class="c1"># italicize book/journal title</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&lt;em&gt;</span><span class="si">%s%s</span><span class="s2">&lt;/em&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">journal</span><span class="p">,</span> <span class="n">ltr_mark</span><span class="p">))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_type</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;Book Section&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">edition</span><span class="p">:</span>
                <span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="s2">&quot;,&quot;</span>
                <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edition_str</span><span class="p">)</span>

        <span class="c1"># Unlike other work types, journal articles&#39; volume/issue numbers</span>
        <span class="c1"># appear before the publisher info and date</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_type</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;Article&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">:</span>
                <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">issue</span><span class="p">:</span>
                <span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="s2">&quot;,&quot;</span>
                <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;no. </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">issue</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">extra_fields</span> <span class="ow">and</span> <span class="ow">not</span> <span class="s2">&quot;model&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_type</span><span class="o">.</span><span class="n">type</span><span class="p">:</span>
            <span class="c1"># Location, publisher, and date (omit for unpublished, unless it has a year)</span>
            <span class="c1"># examples:</span>
            <span class="c1">#   (n.p., n.d.)</span>
            <span class="c1">#   (n.p., 2013)</span>
            <span class="c1">#   (Oxford: n.p., 2013)</span>
            <span class="c1">#   (n.p.: Oxford University Press, 2013)</span>
            <span class="c1">#   (Oxford: Oxford University Press, 2013)</span>
            <span class="c1">#   (PhD diss., n.p., n.d.)</span>
            <span class="c1">#   (PhD diss., n.p., 2013)</span>
            <span class="c1">#   (PhD diss., Oxford University, 2013)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_type</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;Unpublished&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">year</span><span class="p">):</span>
                <span class="c1"># If publisher name present, assign it to &quot;pubname&quot;, otherwise assign n.p.</span>
                <span class="n">pub_name</span> <span class="o">=</span> <span class="s2">&quot;n.p.&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">publisher</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">publisher</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_type</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;Dissertation&quot;</span><span class="p">:</span>
                    <span class="c1"># Add &quot;PhD diss.&quot; and degree granting institution for dissertation</span>
                    <span class="c1"># (do not include place published here)</span>
                    <span class="n">pub_data</span> <span class="o">=</span> <span class="s2">&quot;PhD diss., </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">pub_name</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">place_published</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">publisher</span><span class="p">:</span>
                    <span class="c1"># Add publisher information for all other works, if available</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">place_published</span><span class="p">:</span>
                        <span class="n">pub_data</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">place_published</span><span class="p">,</span> <span class="n">pub_name</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">pub_data</span> <span class="o">=</span> <span class="s2">&quot;n.p.: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">pub_name</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># If not a dissertation and no publisher info, then just use n.p.</span>
                    <span class="n">pub_data</span> <span class="o">=</span> <span class="n">pub_name</span>

                <span class="n">pub_year</span> <span class="o">=</span> <span class="s2">&quot;n.d.&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">year</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">year</span><span class="p">)</span>
                <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;(</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pub_data</span><span class="p">,</span> <span class="n">pub_year</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">year</span><span class="p">:</span>
            <span class="c1"># when extra fields disabled, show year only</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">year</span><span class="p">))</span>

        <span class="c1"># omit volumes for unpublished sources</span>
        <span class="c1"># (those volumes are an admin convienence for managing Goitein content)</span>
        <span class="c1"># and for articles (appears earlier in citation)</span>
        <span class="n">needs_volume</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">volume</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_type</span><span class="o">.</span><span class="n">type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Article&quot;</span><span class="p">,</span> <span class="s2">&quot;Unpublished&quot;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">extra_fields</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">page_range</span><span class="p">:</span>
            <span class="c1"># Page range and/or volume at end of citation</span>
            <span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="s2">&quot;,&quot;</span>
            <span class="k">if</span> <span class="n">needs_volume</span><span class="p">:</span>
                <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">page_range</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">page_range</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">needs_volume</span><span class="p">:</span>
            <span class="c1"># Just volume at end of citation</span>
            <span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="s2">&quot;,&quot;</span>
            <span class="k">if</span> <span class="s2">&quot;Book&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_type</span><span class="o">.</span><span class="n">type</span><span class="p">:</span>
                <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;vol.&quot;</span><span class="p">)</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">)</span>

        <span class="c1"># title and other metadata should be joined by spaces</span>
        <span class="n">ref</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>

        <span class="c1"># use comma delimiter after authors when it does not break citation;</span>
        <span class="c1"># i.e. extra_fields is true, source has a title, or source has a journal</span>
        <span class="c1"># and no non-english languages to list.</span>
        <span class="c1"># examples:</span>
        <span class="c1">#   Allony (in Hebrew), Journal 6 (1964)    (no comma)</span>
        <span class="c1">#   L. B. Yarbrough (in Hebrew)             (no comma)</span>
        <span class="c1">#   Author (1964)                           (no comma)</span>
        <span class="c1">#   Author, Journal 6 (1964)                (comma)</span>
        <span class="c1">#   Author, [digital geniza document edition]                      (comma)</span>
        <span class="n">use_comma</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">extra_fields</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span>
            <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">journal</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">included_langs</span><span class="p">)</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_type</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;Unpublished&quot;</span>
        <span class="p">)</span>
        <span class="n">delimiter</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span> <span class="k">if</span> <span class="n">use_comma</span> <span class="k">else</span> <span class="s2">&quot; &quot;</span>

        <span class="c1"># rstrip to prevent double periods (e.g. in the case of trailing edition abbreviation)</span>
        <span class="k">return</span> <span class="n">delimiter</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">val</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="p">(</span><span class="n">author</span><span class="p">,</span> <span class="n">ref</span><span class="p">)</span> <span class="k">if</span> <span class="n">val</span><span class="p">])</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span></div>


    <span class="n">all_authors</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="s2">&quot;Authors&quot;</span>
    <span class="n">all_authors</span><span class="o">.</span><span class="n">admin_order_field</span> <span class="o">=</span> <span class="s2">&quot;first_author&quot;</span>  <span class="c1"># set in admin queryset</span>

<div class="viewcode-block" id="Source.display">
<a class="viewcode-back" href="../../../codedocs/footnotes.html#geniza.footnotes.models.Source.display">[docs]</a>
    <span class="k">def</span> <span class="nf">display</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;strip HTML tags from formatted display&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">strip_tags</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">formatted_display</span><span class="p">(</span><span class="n">extra_fields</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span></div>


<div class="viewcode-block" id="Source.get_volume_from_shelfmark">
<a class="viewcode-back" href="../../../codedocs/footnotes.html#geniza.footnotes.models.Source.get_volume_from_shelfmark">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_volume_from_shelfmark</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">shelfmark</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Given a shelfmark, get our volume label. This logic was determined in</span>
<span class="sd">        migration 0011_split_goitein_typedtexts.py</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">shelfmark</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;T-S&quot;</span><span class="p">):</span>
            <span class="n">volume</span> <span class="o">=</span> <span class="n">shelfmark</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>
            <span class="n">volume</span> <span class="o">=</span> <span class="s2">&quot;T-S Misc&quot;</span> <span class="k">if</span> <span class="n">volume</span> <span class="o">==</span> <span class="s2">&quot;T-S Mi&quot;</span> <span class="k">else</span> <span class="n">volume</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">volume</span> <span class="o">=</span> <span class="n">shelfmark</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">volume</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">uri</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate a URI for this source to be used in transcription annotations,</span>
<span class="sd">        in order to filter them by associated source&quot;&quot;&quot;</span>
        <span class="c1"># TODO: add a minimal view with json representation of the source so that this uri resolves</span>
        <span class="n">manifest_base_url</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="s2">&quot;ANNOTATION_MANIFEST_BASE_URL&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">urljoin</span><span class="p">(</span><span class="n">manifest_base_url</span><span class="p">,</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;sources&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="p">)))</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span>

<div class="viewcode-block" id="Source.id_from_uri">
<a class="viewcode-back" href="../../../codedocs/footnotes.html#geniza.footnotes.models.Source.id_from_uri">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">id_from_uri</span><span class="p">(</span><span class="n">uri</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Given a URi for a source (as used in transcription annotations), return</span>
<span class="sd">        the source id&quot;&quot;&quot;</span>
        <span class="c1"># TODO: Use resolve() when the json source view exists</span>
        <span class="c1"># (see logic in equivalent Document method)</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span></div>


<div class="viewcode-block" id="Source.from_uri">
<a class="viewcode-back" href="../../../codedocs/footnotes.html#geniza.footnotes.models.Source.from_uri">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_uri</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">uri</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Given a URI for a Source (as used in transcription annotations), return the Source</span>
<span class="sd">        object matching the pk&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">Source</span><span class="o">.</span><span class="n">id_from_uri</span><span class="p">(</span><span class="n">uri</span><span class="p">))</span></div>
</div>



<div class="viewcode-block" id="FootnoteQuerySet">
<a class="viewcode-back" href="../../../codedocs/footnotes.html#geniza.footnotes.models.FootnoteQuerySet">[docs]</a>
<span class="k">class</span> <span class="nc">FootnoteQuerySet</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">QuerySet</span><span class="p">):</span>
<div class="viewcode-block" id="FootnoteQuerySet.includes_footnote">
<a class="viewcode-back" href="../../../codedocs/footnotes.html#geniza.footnotes.models.FootnoteQuerySet.includes_footnote">[docs]</a>
    <span class="k">def</span> <span class="nf">includes_footnote</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if the current queryset includes a match for the</span>
<span class="sd">        specified footnote. Matches are made by comparing content source,</span>
<span class="sd">        location, document relation type, and notes.</span>
<span class="sd">        Returns the matching object if there was one, or False if not.&quot;&quot;&quot;</span>

        <span class="n">compare_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="s2">&quot;location&quot;</span><span class="p">,</span> <span class="s2">&quot;notes&quot;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="nb">all</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="o">==</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">compare_fields</span><span class="p">)</span>
                <span class="c1"># NOTE: fn.doc_relation seems to be different on queryset footnote</span>
                <span class="c1"># than newly created object; check by display value to avoid problems</span>
                <span class="ow">and</span> <span class="n">fn</span><span class="o">.</span><span class="n">get_doc_relation_display</span><span class="p">()</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">get_doc_relation_display</span><span class="p">()</span>
            <span class="p">):</span>
                <span class="k">return</span> <span class="n">fn</span>

        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="FootnoteQuerySet.editions">
<a class="viewcode-back" href="../../../codedocs/footnotes.html#geniza.footnotes.models.FootnoteQuerySet.editions">[docs]</a>
    <span class="k">def</span> <span class="nf">editions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Filter to all footnotes that provide editions/transcriptions.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">doc_relation__contains</span><span class="o">=</span><span class="n">Footnote</span><span class="o">.</span><span class="n">EDITION</span><span class="p">)</span></div>


<div class="viewcode-block" id="FootnoteQuerySet.metadata_prefetch">
<a class="viewcode-back" href="../../../codedocs/footnotes.html#geniza.footnotes.models.FootnoteQuerySet.metadata_prefetch">[docs]</a>
    <span class="k">def</span> <span class="nf">metadata_prefetch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;prefetch source, source authors, and content object&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_related</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">prefetch_related</span><span class="p">(</span>
            <span class="s2">&quot;content_object&quot;</span><span class="p">,</span> <span class="s2">&quot;source__authorship_set__creator&quot;</span>
        <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="Footnote">
<a class="viewcode-back" href="../../../codedocs/footnotes.html#geniza.footnotes.models.Footnote">[docs]</a>
<span class="k">class</span> <span class="nc">Footnote</span><span class="p">(</span><span class="n">TrackChangesModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;a footnote that links a :class:`~geniza.corpus.models.Document` to a :class:`Source`&quot;&quot;&quot;</span>

    <span class="n">source</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Source</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>
    <span class="n">location</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Location within the source &quot;</span>
        <span class="o">+</span> <span class="s2">&quot;(e.g., document number or page range)&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">location_sort</span> <span class="o">=</span> <span class="n">NaturalSortField</span><span class="p">(</span><span class="n">for_field</span><span class="o">=</span><span class="s2">&quot;location&quot;</span><span class="p">)</span>

    <span class="n">EDITION</span> <span class="o">=</span> <span class="s2">&quot;E&quot;</span>
    <span class="n">TRANSLATION</span> <span class="o">=</span> <span class="s2">&quot;T&quot;</span>
    <span class="n">DISCUSSION</span> <span class="o">=</span> <span class="s2">&quot;D&quot;</span>
    <span class="n">DIGITAL_EDITION</span> <span class="o">=</span> <span class="s2">&quot;X&quot;</span>
    <span class="n">DIGITAL_TRANSLATION</span> <span class="o">=</span> <span class="s2">&quot;Y&quot;</span>
    <span class="n">DOCUMENT_RELATION_TYPES</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">EDITION</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Edition&quot;</span><span class="p">)),</span>
        <span class="p">(</span><span class="n">TRANSLATION</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Translation&quot;</span><span class="p">)),</span>
        <span class="p">(</span><span class="n">DISCUSSION</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Discussion&quot;</span><span class="p">)),</span>
        <span class="p">(</span><span class="n">DIGITAL_EDITION</span><span class="p">,</span> <span class="s2">&quot;Digital Edition&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">DIGITAL_TRANSLATION</span><span class="p">,</span> <span class="s2">&quot;Digital Translation&quot;</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">doc_relation</span> <span class="o">=</span> <span class="n">MultiSelectField</span><span class="p">(</span>
        <span class="s2">&quot;Document relation&quot;</span><span class="p">,</span>
        <span class="n">choices</span><span class="o">=</span><span class="n">DOCUMENT_RELATION_TYPES</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;How does the source relate to this document? &quot;</span>
        <span class="o">+</span> <span class="s1">&#39;Please note: &quot;Edition&quot; is a (published or unpublished) &#39;</span>
        <span class="o">+</span> <span class="s1">&#39;transcription. &quot;Digital edition&quot; is the PGP version of an &#39;</span>
        <span class="o">+</span> <span class="s2">&quot;edition, and the source record should NOT be deleted. Footnotes &quot;</span>
        <span class="o">+</span> <span class="s1">&#39;for &quot;editions&quot; and &quot;digital editions&quot; should NOT be combined, &#39;</span>
        <span class="o">+</span> <span class="s2">&quot;even if they refer to the same transcription.&quot;</span><span class="p">,</span>
        <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">notes</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Displays publicly. For minor emendations to a &quot;</span>
        <span class="o">+</span> <span class="s1">&#39;transcription, put &quot;with minor emendations by Your Name, Date.&quot; &#39;</span>
        <span class="o">+</span> <span class="s2">&quot;Do not add a note for typo corrections. For significant &quot;</span>
        <span class="o">+</span> <span class="s2">&quot;alterations to a transcription, create a new source indicating &quot;</span>
        <span class="o">+</span> <span class="s2">&quot;co-authorship.&quot;</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">JSONField</span><span class="p">(</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Transcription content (transitional; edit with care and only when needed)&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">URLField</span><span class="p">(</span>
        <span class="s2">&quot;URL&quot;</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Link to the source (optional)&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Generic relationship</span>
    <span class="n">content_type</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span>
        <span class="n">ContentType</span><span class="p">,</span>
        <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">,</span>
        <span class="n">limit_choices_to</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">Q</span><span class="p">(</span><span class="n">app_label</span><span class="o">=</span><span class="s2">&quot;corpus&quot;</span><span class="p">)</span> <span class="o">|</span> <span class="n">models</span><span class="o">.</span><span class="n">Q</span><span class="p">(</span><span class="n">app_label</span><span class="o">=</span><span class="s2">&quot;entities&quot;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">object_id</span> <span class="o">=</span> <span class="n">GfkLookupField</span><span class="p">(</span>
        <span class="s2">&quot;content_type&quot;</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;If content type is Document, this is PGPID&quot;</span>
    <span class="p">)</span>
    <span class="n">content_object</span> <span class="o">=</span> <span class="n">GenericForeignKey</span><span class="p">()</span>

    <span class="c1"># replace default queryset with customized version</span>
    <span class="n">objects</span> <span class="o">=</span> <span class="n">FootnoteQuerySet</span><span class="o">.</span><span class="n">as_manager</span><span class="p">()</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;source&quot;</span><span class="p">,</span>
            <span class="c1"># sort footnote with empty locations after footnote with location</span>
            <span class="c1"># (sort digital editions after other footnotes for same source)</span>
            <span class="n">NullIf</span><span class="p">(</span><span class="s2">&quot;location_sort&quot;</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">asc</span><span class="p">(</span><span class="n">nulls_last</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="n">constraints</span> <span class="o">=</span> <span class="p">[</span>
            <span class="c1"># only allow one digital edition per source for a document</span>
            <span class="n">models</span><span class="o">.</span><span class="n">UniqueConstraint</span><span class="p">(</span>
                <span class="n">fields</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="s2">&quot;object_id&quot;</span><span class="p">,</span> <span class="s2">&quot;content_type&quot;</span><span class="p">),</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;one_digital_edition_per_document_and_source&quot;</span><span class="p">,</span>
                <span class="n">condition</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">Q</span><span class="p">(</span><span class="n">doc_relation__contains</span><span class="o">=</span><span class="s2">&quot;X&quot;</span><span class="p">),</span>  <span class="c1"># X = DIGITAL_EDITION</span>
            <span class="p">),</span>
            <span class="c1"># only allow one digital translation per source for a document</span>
            <span class="n">models</span><span class="o">.</span><span class="n">UniqueConstraint</span><span class="p">(</span>
                <span class="n">fields</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="s2">&quot;object_id&quot;</span><span class="p">,</span> <span class="s2">&quot;content_type&quot;</span><span class="p">),</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;one_digital_translation_per_document_and_source&quot;</span><span class="p">,</span>
                <span class="n">condition</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">Q</span><span class="p">(</span>
                    <span class="n">doc_relation__contains</span><span class="o">=</span><span class="s2">&quot;Y&quot;</span>
                <span class="p">),</span>  <span class="c1"># Y = DIGITAL_TRANSLATION</span>
            <span class="p">),</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">choices</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DOCUMENT_RELATION_TYPES</span><span class="p">)</span>

        <span class="n">rel</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot; and &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">choices</span><span class="p">[</span><span class="n">c</span><span class="p">])</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">doc_relation</span> <span class="ow">or</span> <span class="p">[])])</span>
            <span class="ow">or</span> <span class="s2">&quot;Footnote&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">rel</span><span class="si">}</span><span class="s2"> of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">content_object</span><span class="si">}</span><span class="s2">&quot;</span>

<div class="viewcode-block" id="Footnote.display">
<a class="viewcode-back" href="../../../codedocs/footnotes.html#geniza.footnotes.models.Footnote.display">[docs]</a>
    <span class="k">def</span> <span class="nf">display</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;format footnote for display; used on document detail page</span>
<span class="sd">        and metadata export for old pgp site&quot;&quot;&quot;</span>
        <span class="c1"># source, location. notes.</span>
        <span class="c1"># source. notes.</span>
        <span class="c1"># source, location.</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">display</span><span class="p">()]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">notes</span><span class="p">:</span>
            <span class="c1"># uppercase first letter of notes if not capitalized</span>
            <span class="n">notes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">notes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">notes</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="c1"># append period to notes if not present</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">notes</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">),</span> <span class="s2">&quot;.&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span></div>


<div class="viewcode-block" id="Footnote.has_url">
<a class="viewcode-back" href="../../../codedocs/footnotes.html#geniza.footnotes.models.Footnote.has_url">[docs]</a>
    <span class="k">def</span> <span class="nf">has_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Admin display field indicating if footnote has a url.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">)</span></div>


    <span class="n">has_url</span><span class="o">.</span><span class="n">boolean</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">has_url</span><span class="o">.</span><span class="n">admin_order_field</span> <span class="o">=</span> <span class="s2">&quot;url&quot;</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">content_html</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;content as html, if available; returns a dictionary of lists.</span>
<span class="sd">        keys are canvas ids, list is html content.&quot;&quot;&quot;</span>
        <span class="c1"># NOTE: previously only returned if type was digital edition;</span>
        <span class="c1"># now that we&#39;re using foreign keys, return content from</span>
        <span class="c1"># any associated annotations, regardless of what doc relation.</span>

        <span class="c1"># NOTE: when we implement translation, will need to filter on</span>
        <span class="c1"># motivation here to distinguish transcription/translation;</span>
        <span class="c1"># may need separate methods for transcription content</span>
        <span class="c1"># and translation content, since one source could provide both</span>

        <span class="c1"># generate return a dictionary of lists of annotation html content</span>
        <span class="c1"># keyed on canvas uri</span>
        <span class="c1"># handle multiple annotations on the same canvas</span>
        <span class="n">html_content</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="c1"># order by optional position property (set by manual reorder in editor), then date</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotation_set</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span>
            <span class="s2">&quot;content__schema:position&quot;</span><span class="p">,</span> <span class="s2">&quot;created&quot;</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">label</span><span class="p">:</span>
                <span class="n">html_content</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">target_source_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;h3&gt;</span><span class="si">{</span><span class="n">a</span><span class="o">.</span><span class="n">label</span><span class="si">}</span><span class="s2">&lt;/h3&gt;&quot;</span><span class="p">)</span>
            <span class="n">html_content</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">target_source_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">body_content</span><span class="p">)</span>
        <span class="c1"># cast to a regular dict to avoid weirdness in django templates</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">html_content</span><span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">content_html_str</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;content as a single string of html, if available&quot;</span>
        <span class="c1"># content html is a dict; values are lists of html content</span>
        <span class="n">content_html</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_html</span>
        <span class="k">if</span> <span class="n">content_html</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">section</span>
                    <span class="k">for</span> <span class="n">canvas_annos</span> <span class="ow">in</span> <span class="n">content_html</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">canvas_annos</span>
                <span class="p">]</span>
            <span class="p">)</span>

<div class="viewcode-block" id="Footnote.explicit_line_numbers">
<a class="viewcode-back" href="../../../codedocs/footnotes.html#geniza.footnotes.models.Footnote.explicit_line_numbers">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">explicit_line_numbers</span><span class="p">(</span><span class="n">html</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;add explicit line numbers to passed HTML (in value attributes of ol &gt; li)&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">html</span><span class="p">:</span>  <span class="c1"># don&#39;t attempt to parse if html is not set</span>
            <span class="n">parser</span> <span class="o">=</span> <span class="n">HTMLLineNumberParser</span><span class="p">()</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">feed</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">parser</span><span class="o">.</span><span class="n">html_str</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">content_text</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;content as plain text, if available&quot;</span>
        <span class="c1"># use beautiful soup to parse html content and return as text</span>
        <span class="c1"># (strips tags and convert entities to plain text equivalent)</span>
        <span class="c1"># but only return if we have content (otherwise returns string &quot;None&quot;)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_html_str</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">content_html_str</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="s2">&quot;lxml&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get_text</span><span class="p">()</span>

<div class="viewcode-block" id="Footnote.iiif_annotation_content">
<a class="viewcode-back" href="../../../codedocs/footnotes.html#geniza.footnotes.models.Footnote.iiif_annotation_content">[docs]</a>
    <span class="k">def</span> <span class="nf">iiif_annotation_content</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return transcription content from this footnote (if any)</span>
<span class="sd">        as a IIIF annotation resource that can be associated with a canvas.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># For now, since we have no block/canvas information, return the</span>
        <span class="c1"># whole thing as a single resource</span>
        <span class="n">html</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_html</span>
        <span class="k">if</span> <span class="n">html</span><span class="p">:</span>
            <span class="c1"># this is the content that should be set as the &quot;resource&quot;</span>
            <span class="c1"># of an annotation</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;@type&quot;</span><span class="p">:</span> <span class="s2">&quot;cnt:ContentAsText&quot;</span><span class="p">,</span>
                <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;text/html&quot;</span><span class="p">,</span>
                <span class="c1"># language todo</span>
                <span class="s2">&quot;chars&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;div dir=&#39;rtl&#39; class=&#39;transcription&#39;&gt;</span><span class="si">%s</span><span class="s2">&lt;/div&gt;&quot;</span> <span class="o">%</span> <span class="n">html</span><span class="p">,</span>
            <span class="p">}</span></div>
</div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">Princeton Geniza Project</a></h1>



<p class="blurb">Django web application and other code for Princeton Geniza Project v4.x</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=Princeton-CDH&repo=geniza&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>







    

<p>
<a class="badge" href="https://codecov.io/github/Princeton-CDH/geniza">
    <img
    alt="https://codecov.io/github/Princeton-CDH/geniza/coverage.svg?branch=master"
    src="https://codecov.io/github/Princeton-CDH/geniza/coverage.svg?branch=master"
    />
</a>
</p>
<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../architecture.html">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../codedocs/index.html">Code Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../devnotes.html">Developer Instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">Change Log</a></li>
</ul>


<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script><div class="powered_by">
    <p>Powered by:</p>
    <a href="http://cdh.princeton.edu/">
        <img src="https://cdh.princeton.edu/static/img/CDH_logo.svg"
            alt="Center for Digital Humanities @ Princeton" />
    </a>
</div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2022, Center for Digital Humanities @ Princeton.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 7.2.6</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
    </div>

    

    
  </body>
</html>