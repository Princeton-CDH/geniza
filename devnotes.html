<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Developer Instructions &#8212; Princeton Geniza Project 4.23.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css?v=12dfc556" />
    <script src="_static/documentation_options.js?v=37cae72d"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Change Log" href="changelog.html" />
    <link rel="prev" title="Annotations" href="codedocs/annotations.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="developer-instructions">
<h1>Developer Instructions<a class="headerlink" href="#developer-instructions" title="Link to this heading">¶</a></h1>
<section id="setup-and-installation">
<h2>Setup and installation<a class="headerlink" href="#setup-and-installation" title="Link to this heading">¶</a></h2>
<p>Initial setup and installation:</p>
<ul>
<li><p>Recommended: create and activate a python 3.9 virtualenv</p></li>
<li><p>Install required python dependencies:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">e</span> <span class="s1">&#39;.[dev]&#39;</span>
</pre></div>
</div>
</li>
<li><p>Recommended: use <a class="reference external" href="https://volta.sh/">Volta</a> for Node version management</p></li>
<li><p>Install required javascript dependencies:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">npm</span> <span class="n">install</span>
</pre></div>
</div>
</li>
<li><p>Copy sample local settings and configure for your environment:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cp</span> <span class="n">geniza</span><span class="o">/</span><span class="n">settings</span><span class="o">/</span><span class="n">local_settings</span><span class="o">.</span><span class="n">py</span><span class="o">.</span><span class="n">sample</span> <span class="n">geniza</span><span class="o">/</span><span class="n">settings</span><span class="o">/</span><span class="n">local_settings</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
</li>
</ul>
<p>Remember to add a <code class="docutils literal notranslate"><span class="pre">SECRET_KEY</span></code> setting!</p>
<ul>
<li><p>Create a new database and update your database settings accordingly</p></li>
<li><p>Run database migrations:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">migrate</span>
</pre></div>
</div>
</li>
<li><p>Compile microcopy and translated content to make it available for the application:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="n">geniza</span> <span class="o">&amp;&amp;</span> <span class="n">django</span><span class="o">-</span><span class="n">admin</span> <span class="n">compilemessages</span>
</pre></div>
</div>
</li>
<li><p>Copy Solr configset into your solr server configset directory. For a local install:</p>
<blockquote>
<div><p>cp -r solr_conf /path/to/solr/server/solr/configsets/geniza
chown solr:solr -R /path/to/solr/server/solr/configsets/geniza</p>
</div></blockquote>
</li>
<li><p>Create Solr collection with the configured configset (use <cite>create_core</cite> with Solr standalone and <cite>create_collection</cite> with SolrCloud):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="s2">&quot;http://localhost:8983/solr/admin/cores?action=CREATE&amp;name=geniza&amp;configSet=geniza&quot;</span>
</pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The command line version of core creation looks like <code class="docutils literal notranslate"><span class="pre">solr</span> <span class="pre">create</span> <span class="pre">-c</span> <span class="pre">geniza</span> <span class="pre">-n</span> <span class="pre">geniza</span></code>, but in
current versions of Solr it creates a new core with a <em>copy</em> of the configset instead of a <em>reference</em>.</p>
</div>
<ul>
<li><p>Index content in Solr:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">index</span>
</pre></div>
</div>
</li>
</ul>
<section id="install-pre-commmit-hooks">
<h3>Install pre-commmit hooks<a class="headerlink" href="#install-pre-commmit-hooks" title="Link to this heading">¶</a></h3>
<p>We use <a class="reference external" href="https://pre-commit.com/">pre-commit</a> to install and manage commit hooks to ensure that code is consistently formatted. To install, run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pre</span><span class="o">-</span><span class="n">commit</span> <span class="n">install</span>
</pre></div>
</div>
<p>Current hooks include Black for python code formatting, isort for standardized python imports, djhtml for consistent indentation in django templates, and prettier for javascript, css, and other supported file types.</p>
<p>Standardized code styles were instituted after development had begun on this project. Consequently, <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">blame</span></code> may not reflect the true author of a given line. In order to see a more accurate <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">blame</span></code> execute the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">git</span> <span class="n">blame</span> <span class="o">&lt;</span><span class="n">FILE</span><span class="o">&gt;</span> <span class="o">--</span><span class="n">ignore</span><span class="o">-</span><span class="n">revs</span><span class="o">-</span><span class="n">file</span> <span class="o">.</span><span class="n">git</span><span class="o">-</span><span class="n">blame</span><span class="o">-</span><span class="n">ignore</span><span class="o">-</span><span class="n">revs</span>
</pre></div>
</div>
<p>Or configure your git to always ignore the black revision commit:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">git</span> <span class="n">config</span> <span class="n">blame</span><span class="o">.</span><span class="n">ignoreRevsFile</span> <span class="o">.</span><span class="n">git</span><span class="o">-</span><span class="n">blame</span><span class="o">-</span><span class="n">ignore</span><span class="o">-</span><span class="n">revs</span>
</pre></div>
</div>
</section>
<section id="fonts">
<h3>Fonts<a class="headerlink" href="#fonts" title="Link to this heading">¶</a></h3>
<p>Fonts are stored in <code class="docutils literal notranslate"><span class="pre">sitemedia/fonts/</span></code>. Since this project uses paid licensed fonts, this directory is ignored by git and not checked into version control.</p>
<p>Instead, licnsed fonts are stored in an AES-256 encrypted <code class="docutils literal notranslate"><span class="pre">.zip</span></code> archive, and this file is checked into the repo. The encryption key is stored as a GitHub Secret, used by Percy (visual regression testing service) and Lighthouse (accessibility testing serivce) to decrypt and use the fonts in GitHub Actions.</p>
<p>To install fonts locally:</p>
<ul>
<li><p>Download <code class="docutils literal notranslate"><span class="pre">.woff</span></code> and <code class="docutils literal notranslate"><span class="pre">.woff2</span></code> files from the shared Google Drive folder “Geniza – woff files only”.</p></li>
<li><p>Create the <code class="docutils literal notranslate"><span class="pre">fonts</span></code> subdirectory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="n">sitemedia</span> <span class="o">&amp;&amp;</span> <span class="n">mkdir</span> <span class="n">fonts</span>
</pre></div>
</div>
</li>
<li><p>Move or copy all the <code class="docutils literal notranslate"><span class="pre">.woff</span></code> and <code class="docutils literal notranslate"><span class="pre">.woff2</span></code> files into that subdirectory.</p></li>
</ul>
<p>Alternatively, if you have access to a project maintainer who has the decryption passphrase, you can decrypt and unzip the file with GPG (via the <code class="docutils literal notranslate"><span class="pre">gpg</span></code> package on Unix or <a class="reference external" href="https://gpgtools.org/">GPGTools</a> on MacOS) and <code class="docutils literal notranslate"><span class="pre">unzip</span></code> or your preferred unzipper:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gpg</span> <span class="o">--</span><span class="n">quiet</span> <span class="o">--</span><span class="n">batch</span> <span class="o">--</span><span class="n">yes</span> <span class="o">--</span><span class="n">decrypt</span> <span class="o">--</span><span class="n">passphrase</span><span class="o">=</span><span class="s2">&quot;PASSPHRASE&quot;</span> <span class="o">--</span><span class="n">output</span> <span class="n">fonts</span><span class="o">.</span><span class="n">zip</span> <span class="n">fonts</span><span class="o">.</span><span class="n">zip</span><span class="o">.</span><span class="n">gpg</span>
<span class="n">unzip</span> <span class="o">-</span><span class="n">q</span> <span class="o">-</span><span class="n">o</span> <span class="n">sitemedia</span><span class="o">/</span><span class="n">fonts</span><span class="o">.</span><span class="n">zip</span> <span class="o">-</span><span class="n">d</span> <span class="n">sitemedia</span>
</pre></div>
</div>
<p>Where <code class="docutils literal notranslate"><span class="pre">PASSPHRASE</span></code> is the correct passphrase.</p>
<p>If you need to add fonts to the bundle, you will need access to the original font files, either by using the above commands to decrypt and unizp the original encrypted file (recommended), or by following the Google Drive steps. Add your new fonts to the <cite>fonts</cite> directory, and then zip and re-encrypt with the following commands:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="n">sitemedia</span>
<span class="n">rm</span> <span class="o">-</span><span class="n">rf</span> <span class="n">fonts</span><span class="o">.</span><span class="n">zip</span><span class="o">.</span><span class="n">gpg</span>    <span class="c1"># Remove the original encrypted file</span>
<span class="nb">zip</span> <span class="o">-</span><span class="n">r</span> <span class="n">fonts</span><span class="o">.</span><span class="n">zip</span> <span class="n">fonts</span>  <span class="c1"># Compress the directory into a new zip file</span>
<span class="n">gpg</span> <span class="o">--</span><span class="n">symmetric</span> <span class="o">--</span><span class="n">cipher</span><span class="o">-</span><span class="n">algo</span> <span class="n">AES256</span> <span class="n">fonts</span><span class="o">.</span><span class="n">zip</span> <span class="c1"># Generate a new encrypted file</span>
<span class="n">rm</span> <span class="o">-</span><span class="n">rf</span> <span class="n">fonts</span><span class="o">.</span><span class="n">zip</span>        <span class="c1"># Remove the unencrypted zip</span>
</pre></div>
</div>
<p>When prompted after entering the <code class="docutils literal notranslate"><span class="pre">gpg</span></code> command, you must use the same passphrase that was previously used to encrypt the file, or store the new passphrase in GitHub Secrets in a variable called <code class="docutils literal notranslate"><span class="pre">GPG_PASSPHRASE</span></code>.</p>
</section>
<section id="static-files">
<h3>Static Files<a class="headerlink" href="#static-files" title="Link to this heading">¶</a></h3>
<p>Static files are stored in <code class="docutils literal notranslate"><span class="pre">sitemedia/</span></code> and bundled by Webpack. The <code class="docutils literal notranslate"><span class="pre">webpack-bundle-tracker</span></code> plugin generates a JSON manifest file listing the name and location of bundled files. This file, <code class="docutils literal notranslate"><span class="pre">webpack-stats.json</span></code>, is read by Django using <code class="docutils literal notranslate"><span class="pre">django-webpack-loader</span></code> so that the relevant files can be included in the template’s <code class="docutils literal notranslate"><span class="pre">&lt;head&gt;</span></code>.</p>
<p>Bundled files will be output into the <code class="docutils literal notranslate"><span class="pre">sitemedia/bundles</span></code> directory and picked up by Django’s <code class="docutils literal notranslate"><span class="pre">collectstatic</span></code> command. To recompile bundles after making changes:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">npm</span> <span class="n">run</span> <span class="n">build</span>
</pre></div>
</div>
<p>When actively developing stylesheets and scripts, you can instead run a development Webpack server, which will recompile the bundle and refresh your browser when changes are saved:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">npm</span> <span class="n">start</span>
</pre></div>
</div>
<p>Note that switching to the development Webpack server requires restarting your Django server, if one is running, in order to pick up the changes in <code class="docutils literal notranslate"><span class="pre">webpack-stats.json</span></code>.</p>
<p>JavaScript sources are transpiled using Babel so that modern features are supported. Source files that will be transpiled are stored using the <code class="docutils literal notranslate"><span class="pre">.esm.js</span></code> (EcmaScript module) file extension to indicate that they should not be directly included in templates. These files will not be collected as part of Django’s <code class="docutils literal notranslate"><span class="pre">collectstatic</span></code> command.</p>
<p>SCSS sources are compiled using Autoprefixer so that vendor prefixes for browser support of newer CSS features will be added automatically. Source files to be transpiled are stored with the <code class="docutils literal notranslate"><span class="pre">.scss</span></code> file extension for interoperability with CSS. These files will not be collected as part of Django’s <code class="docutils literal notranslate"><span class="pre">collectstatic</span></code> command.</p>
<p>See the <code class="docutils literal notranslate"><span class="pre">.browserslistrc</span></code> file for more information about browser versions officially supported by this application. This file controls the automatic insertion of vendor prefixes for CSS and polyfills for JavaScript so that bundled styles and scripts will be supported on all target browsers.</p>
</section>
<section id="internationalization-translation">
<h3>Internationalization &amp; Translation<a class="headerlink" href="#internationalization-translation" title="Link to this heading">¶</a></h3>
<p>This application has internationalization and translation enabled.</p>
<ul>
<li><p>If you create any new translatable content, you should run <a class="reference external" href="https://docs.djangoproject.com/en/3.1/ref/django-admin/#makemessages">makemessages</a> to create or update message files. We use a customized version of this command, available in <code class="docutils literal notranslate"><span class="pre">/geniza/common/management/commands/makemessages.py</span></code>.</p>
<blockquote>
<div><p>django-admin makemessages –all</p>
</div></blockquote>
</li>
<li><p>Before running the app, you should run <a class="reference external" href="https://docs.djangoproject.com/en/3.1/ref/django-admin/#compilemessages">compilemessages</a> to generate compiled translations.</p>
<blockquote>
<div><p>django-admin compilemessages</p>
</div></blockquote>
</li>
</ul>
</section>
</section>
<section id="unit-tests">
<h2>Unit Tests<a class="headerlink" href="#unit-tests" title="Link to this heading">¶</a></h2>
<p>Python unit tests are written with <a class="reference external" href="http://doc.pytest.org/">py.test</a>
and should be run with <code class="docutils literal notranslate"><span class="pre">pytest</span></code>.</p>
</section>
<section id="end-to-end-tests">
<h2>End-to-end Tests<a class="headerlink" href="#end-to-end-tests" title="Link to this heading">¶</a></h2>
<p>Performance, accessibility, SEO and more are audited via <a class="reference external" href="https://developers.google.com/web/tools/lighthouse">Lighthouse</a>. The tool runs in a GitHub actions workflow (<code class="docutils literal notranslate"><span class="pre">lighthouse.yml</span></code>).</p>
<p>Lighthouse runs several checks by visiting a list of URLs and averaging the results. If new pages are adding to the site, a corresponding URL should be added to the configuration file <code class="docutils literal notranslate"><span class="pre">lighthouserc.js</span></code>.</p>
<p>If the Lighthouse build is generating errors that need to be temporarily or permanently ignored, the corresponding error code can be set to “off” or “warn” in <code class="docutils literal notranslate"><span class="pre">lighthouserc.js</span></code>.</p>
</section>
<section id="visual-tests">
<h2>Visual Tests<a class="headerlink" href="#visual-tests" title="Link to this heading">¶</a></h2>
<p>Visual regressions are monitored with <a class="reference external" href="https://percy.io/">Percy</a>. Percy takes screenshots of the web application with different browsers and compares them to a set of base screenshots to find changes.</p>
<p>In this repository, a GitHub Action is configured to take a set of Percy screenshots when one of the following conditions is met:</p>
<ol class="arabic simple">
<li><p>A commit has been pushed to a pull request against the <code class="docutils literal notranslate"><span class="pre">develop</span></code> branch, and the phrase <code class="docutils literal notranslate"><span class="pre">[run</span> <span class="pre">percy]</span></code> is present in the commit message.</p></li>
<li><p>A commit has been pushed to the <code class="docutils literal notranslate"><span class="pre">develop</span></code> branch, and the phrase <code class="docutils literal notranslate"><span class="pre">[skip</span> <span class="pre">percy]</span></code> is NOT present in the commit message.</p></li>
</ol>
<p>Otherwise, the action will be skipped and Percy will not take a set of screenshots to check for visual regressions.</p>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">Princeton Geniza Project</a></h1>



<p class="blurb">Django web application and other code for Princeton Geniza Project v4.x</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=Princeton-CDH&repo=geniza&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>







    

<p>
<a class="badge" href="https://codecov.io/github/Princeton-CDH/geniza">
    <img
    alt="https://codecov.io/github/Princeton-CDH/geniza/coverage.svg?branch=master"
    src="https://codecov.io/github/Princeton-CDH/geniza/coverage.svg?branch=master"
    />
</a>
</p>
<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="architecture.html">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="codedocs/index.html">Code Documentation</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Developer Instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="changelog.html">Change Log</a></li>
</ul>


  <div>
    <h3><a href="index.html">Table of Contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">Developer Instructions</a><ul>
<li><a class="reference internal" href="#setup-and-installation">Setup and installation</a><ul>
<li><a class="reference internal" href="#install-pre-commmit-hooks">Install pre-commmit hooks</a></li>
<li><a class="reference internal" href="#fonts">Fonts</a></li>
<li><a class="reference internal" href="#static-files">Static Files</a></li>
<li><a class="reference internal" href="#internationalization-translation">Internationalization &amp; Translation</a></li>
</ul>
</li>
<li><a class="reference internal" href="#unit-tests">Unit Tests</a></li>
<li><a class="reference internal" href="#end-to-end-tests">End-to-end Tests</a></li>
<li><a class="reference internal" href="#visual-tests">Visual Tests</a></li>
</ul>
</li>
</ul>

  </div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><div class="powered_by">
    <p>Powered by:</p>
    <a href="http://cdh.princeton.edu/">
        <img src="https://cdh.princeton.edu/static/img/CDH_logo.svg"
            alt="Center for Digital Humanities @ Princeton" />
    </a>
</div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2022, Center for Digital Humanities @ Princeton.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 7.4.7</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
      |
      <a href="_sources/devnotes.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>