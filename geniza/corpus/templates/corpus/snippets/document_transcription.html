{% load i18n static corpus_extras %}
{% if perms.corpus.change_document and document.iiif_urls and not edit_mode %}
    <a class="editor-navigation" href="{% url 'corpus:document-transcription-editor' document.id %}" data-turbo="false">
        <i class="ph-pencil"></i>
        {# Translators: Transcription edit link for admins #}
        <span>{% translate 'Edit transcription' %}</span>
    </a>
{% endif %}
{% if perms.corpus.change_document and edit_mode %}
    {{ annotation_config|json_script:"annotation-config" }}
{% endif %}
<section id="itt-panel"{% if edit_mode %} class="editor"{% endif %} data-controller="transcription" data-action="click@document->transcription#clickCloseDropdown">
    {# NOTE: inputs must be kept as SIBLINGS of panel-container for CSS selection/controls #}
    {# images displayed by default; disable if no images are available #}
    {# translators: label for checkbox toggle to show the images panel for a document #}
    <input type="checkbox" class="toggle" id="images-on" aria-label="{% translate 'show images' %}" {% if document.has_image %}checked="true" {% else %} disabled="true"{% endif %}/>
    <label for="images-on"></label>
    {# transcription displayed by default; disable if no content is available #}
    {# translators: label for checkbox toggle to show the transcription panel for a document #}
    <input type="checkbox" class="toggle" id="transcription-on" aria-label="{% translate 'show transcription' %}" {% if document.digital_editions or edit_mode %}checked="true" {% else %} disabled="true"{% endif %}/>
    <label for="transcription-on"><svg><use xlink:href="{% static 'img/ui/all/all/transcription-toggle.svg' %}#transcription-toggle" /></svg></label>
    {# translation disabled for now since we don't handle them in the system yet #}
    {# translators: label for checkbox toggle to show the translation panel for a document #}
    <input type="checkbox" class="toggle" id="translation-on" aria-label="{% translate 'show translation' %}" disabled="true"/>
    <label for="translation-on"><svg><use xlink:href="{% static 'img/ui/all/all/translation-toggle.svg' %}#translation-toggle" /></svg></label>
    <div class="panel-container">
        {# label row #}
        <div class="label-row"></div> {# unused (no image label, needed for column alignment) #}
        <div class="transcription-panel label-row">
            {# dropdown is disabled by default; enable if javascript is active #}
            <details class="transcription-select" aria-expanded="false" data-transcription-target="dropdownDetails" data-edition-count="{{ document.digital_editions.count }}" disabled="true">
                <summary class="transcription-select-trigger" data-action="keydown->transcription#shiftTabCloseDropdown">
                    <span data-transcription-target="editionShortLabel">Edition: {{ document.digital_editions.0.source.all_authors }}</span>
                </summary>
                <ul>
                    {% for ed in document.digital_editions.all %}
                        <li>
                            <label for="edition-{{ forloop.counter }}">
                                <input type="radio" name="transcription" {% if forloop.first %} checked="true"{% endif %} value="relevance" data-action="input->transcription#changeTranscription keydown->transcription#keyboardCloseDropdown" id="edition-{{ forloop.counter }}" data-edition="ed-{{ ed.pk }}" />
                                <span>Edition: {{ ed.source.all_authors }}</span>
                            </label>
                        </li>
                    {% endfor %}
                </ul>
            </details>
        </div>

        {% comment %}
NOTE: if we have more transcription pages than images,
they won't show in current implementation.
May want to gather them in the model... (but transcription content format will change)
Also doesn't currently account for fragments without images.
        {% endcomment %}
        {# if we have images, loop based on them #}
        {% if document.iiif_urls %}
            {% for image_info in document.iiif_images %}
                <div class="img" id="{{ image_info.label }}" data-controller="iiif" data-iiif-url="{{ image_info.image.info }}" data-canvas-url="{{ image_info.canvas }}" data-iiif-target="imageContainer" data-action="click->iiif#scrollTo0">
                    <div class="img-header">
                        <h3>{{ image_info.shelfmark }} {{ image_info.label }}</h3>
                        <input data-action="iiif#handleDeepZoom" type="range" id="zoom-slider-{{ forloop.counter0 }}" name="zoom-slider" min="1" max="100" value="0" step="0.01">
                        <label for="zoom-slider-{{ forloop.counter0 }}">100%</label>
                        <input data-action="iiif#handleDeepZoom" type="checkbox" id="zoom-toggle-{{ forloop.counter0 }}" name="zoom-toggle">
                        <label for="zoom-toggle-{{ forloop.counter0 }}">{% translate 'Zoom and Rotate' %}</label>
                    </div>
                    <img class="iiif-image" src="{{ image_info.image|iiif_image:"size:width=500" }}" alt="{{ image_info.label }}" title="{{ image_info.label }}" loading="lazy"
                        sizes="(max-width: 650px) 50vw, 94vw"
                        srcset="{{ image_info.image|iiif_image:"size:width=300" }} 300w,
                        {{ image_info.image|iiif_image:"size:width=500" }} 500w,
                        {{ image_info.image|iiif_image:"size:width=640" }} 640w,
                        {{ image_info.image|iiif_image:"size:width=1000" }} 1000w">
                </div>
                <div class="transcription-panel">
                    {% if forloop.first %}
                        <h3>Transcription</h3>
                        <span data-transcription-target="editionFullLabel" class="current-transcription">{{ document.digital_editions.0.display|safe }}</span>
                    {% endif %}
                    <div class="editions">
                        {# display transcription in chunks by index #}
                        {% for edition in document.digital_editions.all %}
                            <div class="transcription ed-{{ edition.pk }}" data-label="{{ edition.display|safe }}">
                                {{ edition.content.html|index:forloop.parentloop.counter0|h1_to_h3|safe }}
                            </div>
                        {% endfor %}
                    </div>
                </div>
                {% if perms.corpus.change_document and edit_mode %}
                    <div class="annotate" data-manifest="{% url 'corpus:document-manifest' document.pk %}">
                        {% if forloop.first %}
                            <h3>{% translate 'Transcribe' %}</h3>
                            <p class="instructions">
                                {% translate 'Hold shift and then click on the image and drag to select a rectangular region for the block text you want to transcribe.' %}
                            </p>
                        {% endif %}
                    </div>
                {% endif %}
            {% endfor %}
            {# if there are no images, loop based on the transcription chunks instead #}
        {% elif document.has_transcription %}
            {% for chunk in document.digital_editions.0.content.html %}
                <div class="img"></div> {# empty image div needed for grid layout #}
                <div class="transcription-panel">
                    {% if forloop.first %}<h3>Transcription</h3>{% endif %}
                    {# display transcription in chunks based on loop index #}
                    <div class="transcription">{{ chunk|h1_to_h3|safe }}</div>
                </div>
                {% if perms.corpus.change_document and edit_mode %}
                    <div class="annotate" data-manifest="{% url 'corpus:document-manifest' document.pk %}">
                        {% if forloop.first %}
                            <h3>{% translate 'Transcribe' %}</h3>
                            <p class="instructions">
                                {% translate 'Hold shift and then click on the image and drag to select a rectangular region for the block text you want to transcribe.' %}
                            </p>
                        {% endif %}
                    </div>
                {% endif %}
            {% endfor %}
        {% endif %}
        {% if document.has_image %}
            {% include "corpus/snippets/document_image_rights.html" %}
        {% endif %}
    </div>
</section>
